<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>NodeAtlas Index</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	<link type="text/css" rel="stylesheet" href="styles/site.simplex.css">

</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top ">
		<div class="navbar-inner">
			<a class="brand" href="index.html">NodeAtlas</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="namespaces.list.html" class="dropdown-toggle" data-toggle="dropdown">Namespaces<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="node-atlas-NA.html">node-atlas~NA</a>
						</li>
						
						<li>
							<a href="node-atlas-NA.modules.html">node-atlas~NA.modules</a>
						</li>
						
						<li>
							<a href="node-atlas-NA.variations.html">node-atlas~NA.variations</a>
						</li>
						
						<li>
							<a href="node-atlas-NA.webconfig.html">node-atlas~NA.webconfig</a>
						</li>
						
						<li>
							<a href="node-atlas-NA.websiteController%255B%255D.html">node-atlas~NA.websiteController[]</a>
						</li>
						
						<li>
							<a href="node-atlas-NA_currentRouteParameters.html">node-atlas~NA#currentRouteParameters</a>
						</li>
						
						<li>
							<a href="node-atlas-NA_currentVariation.html">node-atlas~NA#currentVariation</a>
						</li>
						

					</ul>
				</li>
				
				<li class="dropdown">
					<a href="modules.list.html" class="dropdown-toggle" data-toggle="dropdown">Modules<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="module-node-atlas.html">node-atlas</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
		<div class="span8">
			
				<div id="main">
					


	
	<span class="page-title">Index</span>
	
	












	
	





    <section class="readme-section">
        <article><h1>node-atlas</h1><p>Version : 0.41</p>
<p><strong>For an international version of this README.md, <a href="https://haeresis.github.com/NodeAtlas/doc/">follow this link</a>.</strong></p>
<h2>Avant-propos</h2><p>NodeAtlas est une application réalisée en JavaScript et tournant avec <a href="http://nodejs.org/">Node.js</a>. Elle permet trois choses :</p>
<ul>
<li>Créer et maintenir un ensemble d'assets HTML/CSS/JavaScript pour les fournir à des développeurs Back-end.</li>
<li>Créer et maintenir des sites multilingues sans Back-end.</li>
<li>Développer des sites ou des applications Node.js multilingues de toutes tailles.</li>
</ul>
<h3>Exemples de réalisations avec NodeAtlas</h3><p>L'outil est encore en développement et je l'expérimente petit à petit avec mes propres sites.</p>
<ul>
<li><a href="https://github.com/Haeresis/ResumeAtlas/">Génération et maintenance de maquette HTML</a>.</li>
<li><a href="https://github.com/Haeresis/ResumeAtlas/">Maintenance de site HTML (sans Back-end)</a>.</li>
<li><a href="https://github.com/Haeresis/BookAtlas/">Site Node.js avec Websocket et PopState</a>.</li>
<li><a href="https://github.com/Haeresis/BlogAtlas/">Site Node.js avec base MongoDB et Redis</a>.</li>
<li><a href="https://github.com/Haeresis/EditAtlas/">Exemple Node.js de modification de contenu live sans Back-office</a>.</li>
<li><a href="https://github.com/Haeresis/SimpleAtlas/">Simple Serveur Web pour un dossier</a>.</li>
<li><a href="https://github.com/Haeresis/LessAtlas/">Utilisation du préprocesseur Less pour des Framework non invasif dans le HTML</a>.</li>
</ul>
<h3>Table des matières</h3><ul>
<li><a href="#avant-propos">Avant-propos</a><ul>
<li><a href="#exemples-de-r%C3%A9alisations-avec-nodeatlas">Exemple de réalisations avec NodeAtlas</a></li>
<li><a href="#table-des-mati%C3%A8res">Table des matières</a></li>
<li><a href="#roadmap-davancement-du-d%C3%A9veloppement">Roadmap d'avancement du développement</a></li>
<li><a href="#documentation">Documentation</a></li>
</ul>
</li>
<li><a href="#installation">Installation</a></li>
<li><a href="#commencer-avec-nodeatlas">Commencer avec NodeAtlas</a><ul>
<li><a href="#ensemble-de-fichiers">Ensemble de fichiers</a></li>
<li><a href="#configuration-minimale">Configuration minimale</a></li>
<li><a href="#lancer-le-site-avec-nodeatlas">Lancer le site avec NodeAtlas</a></li>
</ul>
</li>
<li><a href="#diff%C3%A9rentes-configurations-du-webconfigjson">Différentes configurations du webconfig.json</a><ul>
<li><a href="#plusieurs-pages">Plusieurs pages</a></li>
<li><a href="#raccourci-de-template">Raccourci de template</a></li>
<li><a href="#h%C3%A9berger-des-images-polices-css-js-etc">Héberger des images, polices, CSS, JS, etc.</a></li>
<li><a href="#g%C3%A9rer-des-inclusions-pour-%C3%A9viter-la-redondance-du-code">Gérer des inclusions pour éviter la redondance du code</a></li>
<li><a href="#g%C3%A9rer-des-variations-au-sein-dun-m%C3%AAme-template">Gérer des variations au sein d'un même template</a></li>
<li><a href="#g%C3%A9rer-le-multilingue">Gérer le multilingue</a></li>
<li><a href="#utiliser-nodeatlas-pour-g%C3%A9n%C3%A9rer-des-assets-html">Utiliser NodeAtlas pour générer des assets HTML</a></li>
<li><a href="#utiliser-nodeatlas-pour-faire-tourner-un-site-partie-back-end">Utiliser NodeAtlas pour faire tourner un site (partie Back-end)</a></li>
<li><a href="#changer-les-param%C3%A8tres-durl">Changer les paramètres d'url</a></li>
<li><a href="#cr%C3%A9er-ses-propres-variables-de-webconfig">Créer ses propres variables de webconfig</a></li>
<li><a href="#g%C3%A9rer-le-routage-url-rewriting">Gérer le routage (Url Rewriting)</a></li>
<li><a href="#g%C3%A9rer-les-pages-inexistantes">Gérer les pages inexistantes</a></li>
<li><a href="#g%C3%A9rer-les-redirections">Gérer les redirections</a></li>
<li><a href="#faire-tourner-le-site-en-https">Faire tourner le site en HTTPs</a></li>
<li><a href="#minifier-les-cssjs">Minifier les CSS/JS</a></li>
<li><a href="#g%C3%A9n%C3%A9rer-les-css-avec-less">Générer les CSS avec Less</a></li>
<li><a href="#optimiser-les-images">Optimiser les Images</a></li>
<li><a href="#injecter-du-css-inline-pour-maintenir-des-assets-email">Injecter du CSS inline pour maintenir des assets Email</a></li>
<li><a href="#autoriserinterdire-les-demandes-getpost">Autoriser/Interdire les demandes GET/POST</a></li>
<li><a href="#changer-les-param%C3%A8tres-des-sessions">Changer les paramètres des Sessions</a></li>
<li><a href="#stockage-externe-des-sessions">Stockage externe des Sessions</a></li>
<li><a href="#changer-les-chevrons---du-moteur-de-template">Changer les chevrons &lt;% %&gt; du moteur de template</a></li>
<li><a href="#changer-lurl-final-des-hostname-et-port-d%C3%A9coute">Changer l'url final des hostname et port d'écoute</a></li>
<li><a href="#g%C3%A9n%C3%A9rer-les-urls-dynamiquement">Générer les urls dynamiquement</a></li>
</ul>
</li>
<li><a href="#cli-commandes-de-lancement">CLI / Commandes de lancement</a><ul>
<li><a href="#--directory">--directory</a></li>
<li><a href="#--webconfig">--webconfig</a></li>
<li><a href="#--browse">--browse</a></li>
<li><a href="#--httpport">--httpPort</a></li>
<li><a href="#--generate">--generate</a></li>
</ul>
</li>
<li><a href="#api-nodeatlas-comme-module-npm">API / NodeAtlas comme module npm</a></li>
<li><a href="#nodeatlas-comme-simple-serveur-web">NodeAtlas comme simple serveur web</a></li>
<li><a href="#faire-tourner-nodeatlas-sur-serveur">Faire tourner NodeAtlas sur serveur</a><ul>
<li><a href="#dans-un-environnement-windows-server-avec-iisnode">Dans un environnement Windows Server avec iisnode</a></li>
<li><a href="#dans-un-environnement-unix-avec-forever">Dans un environnement Unix avec forever</a></li>
<li><a href="#proxy">Proxy</a></li>
</ul>
</li>
<li><a href="#%C3%80-propos-de-larchitecture-de-nodeatlas">À propos de l'architecture de NodeAtlas</a></li>
</ul>
<h3>Roadmap d'avancement du développement</h3><ul>
<li><p>Fait </p>
<ul>
<li>Lancement d'un serveur Express.</li>
<li>Génération live de maquette HTML.</li>
<li>Génération complète de maquette HTML.</li>
<li>Fichier de configuration (Liste des pages avec Url Rewriting).</li>
<li>Support d'une partie Back-end possible (Controllers / Models).</li>
<li>Exemple d'utilisation de BDD possible (MySql / MongoDB / etc.).</li>
<li>Support des Sessions.</li>
<li>Exemple de Socket.IO avec Handshake.</li>
<li>Support des middlewares de Express.</li>
<li>Support des variables personnelles de webconfig.</li>
<li>Migration Connect 2.x vers Connect 3.x.</li>
<li>Migration Express 3.x vers Express 4.x.</li>
<li>Retrait de Connect 3.x.</li>
<li>Exemple de reverse-proxy pour plusieurs instances sur port 80.</li>
<li>Lancer NodeAtlas avec un require() depuis un fichier de code.</li>
<li>Installer automatiquement NodeAtlas depuis npm.</li>
<li>Minification de CSS/JS à la génération.</li>
<li>Agrégation de fichier CSS/JS via des Bundles.</li>
<li>Support d'une BDD de Session (Redis / MongoDB).</li>
<li>Lancement rapide sans « webconfig » juste en tant que simple serveur web.</li>
<li>Routage partagé via un fichier externe.</li>
<li>Bundle partagé via un fichier externe.</li>
<li>Documentation de l'API (documentation JSDoc du fichier node-atlas.js)</li>
<li>Exemple de Socket.IO 1.0 avec Handshake.</li>
<li>Traduction du fichier README.md en anglais.</li>
<li>Créer une commande <code>nodeatlas</code> en installation globale.</li>
<li>Support Less.</li>
<li>Support HTTPs (WSs aussi).</li>
<li>Compression des images.</li>
<li>Injection automatique de feuille CSS en style inline (pour les maquettes email).</li>
<li>Migration EJS 1.x vers EJS 2.x.</li>
</ul>
</li>
<li><p>À venir et avec votre aide !</p>
<ul>
<li>Tests globaux sur divers projets.</li>
<li>Relecture et tests du README fr.</li>
<li>Amélioration du README en.</li>
<li>Création d'un site EN/FR dédié au projet avec NodeAtlas.</li>
<li>Passage en 1.0.0.</li>
</ul>
</li>
</ul>
<h3>Documentation</h3><p>En complément de ce README (Fr), vous avez également accès au,</p>
<ul>
<li><a href="http://blog.lesieur.name/nodeatlas-le-framework-nodejs-mvc2-oriente-front-end/">tl;dr</a> (Fr),</li>
<li><a href="https://github.com/Haeresis/NodeAtlas/blob/master/node-atlas.js">Explications de code</a> (En) et au,</li>
<li><a href="http://haeresis.github.io/NodeAtlas/doc/namespaces.list.html">détail des fonctions publiques de l'objet NA</a> (En).</li>
</ul>
<h2>Installation</h2><p>Il y a plusieurs solutions pour installer Node-Atlas :</p>
<ul>
<li><p>Télécharger NodeAtlas depuis le site officiel <a href="https://github.com/Haeresis/NodeAtlas">NodeAtlas</a>.</p>
<p> <em>Une fois téléchargé, dézippez <strong>NodeAtlas</strong> dans le dossier qui vous conviendra.</em></p>
<p> <strong>Lancer au moins une fois NodeAtlas à la ligne de commande <code>\&gt; node &lt;/path/to/&gt;node-atlas/node-atlas.js</code>, pour installer les <em>node_modules</em>.</strong></p>
</li>
<li><p><code>npm install node-atlas</code> (recommandé pour un <a href="#nodeatlas-comme-module-npm">usage sous forme de module</a> dans un projet).</p>
<p> <em>Ceci installera <strong>NodeAtlas</strong> dans le dossier <code>node_modules/node-atlas</code> du dossier d'execution de la commande.</em></p>
</li>
<li><p><code>npm install -g node-atlas</code> (recommandé pour un <a href="#nodeatlas-comme-module-npm">usage sous forme de module</a> dans beaucoup de projet ou pour un usage à la ligne de commande).</p>
<p> <em>Ceci installera <strong>NodeAtlas</strong> dans le dossier <code>node_modules/node-atlas</code> global.</em></p>
</li>
<li><p>Cloner le répertoire depuis <a href="https://github.com/Haeresis/NodeAtlas/">GitHub</a>.</p>
<p> <em>Ceci installera <strong>NodeAtlas</strong> dans le dossier d'accueil du clonage.</em></p>
<p> <strong>Lancez au moins une fois NodeAtlas à la ligne de commande <code>\&gt; node &lt;/path/to/&gt;node-atlas/node-atlas.js</code>, pour installer les <em>node_modules</em>.</strong></p>
</li>
</ul>
<h2>Commencer avec NodeAtlas</h2><h3>Ensemble de fichiers</h3><p>Après avoir installé NodeAtlas quelque part sur votre machine, créez-vous un ensemble de fichiers représentant un site n'importe où ailleurs comme la structure ci-dessous.</p>
<pre class="prettyprint source"><code>site-hello-world/
— templates/
—— index.htm
— webconfig.json</code></pre><p>Voici le fichier « /site-hello-world/templates/index.htm » :</p>
<pre class="prettyprint source lang-html"><code>&lt;!DOCTYPE html>
&lt;html lang=&quot;fr-fr&quot;>
    &lt;head>
        &lt;meta charset=&quot;utf-8&quot; />
        &lt;title>Hello world&lt;/title>
    &lt;/head>
    &lt;body>
        &lt;div>Ceci est un Hello World !&lt;/div>
    &lt;/body>
&lt;/html></code></pre><p>et ci-après, le fichier « /site-hello-world/webconfig.json ».</p>
<h3>Configuration minimale</h3><p>Vous pouvez faire tourner une page simple avec la configuration minimale du « webconfig.json » ci-dessous</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>équivalente à</p>
<pre class="prettyprint source lang-js"><code>{ &quot;routes&quot;: { &quot;/&quot;: &quot;index.htm&quot; } }</code></pre><h3>Lancer le site avec NodeAtlas</h3><h4>À la ligne de commande en appelant le script</h4><p>Placez-vous avec un invité de commande dans le dossier « /site-hello-world/ » et exécutez la commande suivante.</p>
<pre class="prettyprint source"><code>\> node &lt;/path/to/>node-atlas/node-atlas.js</code></pre><p>À votre première exécution, NodeAtlas installera tous les « node_modules » nécessaires à son fonctionnement (si vous avez téléchargé hors npm).</p>
<p>Ré-exécutez.</p>
<pre class="prettyprint source"><code>\> node &lt;/path/to/>node-atlas/node-atlas.js</code></pre><p>Vous aurez accès à votre « Hello World » à la page <em>http://localhost/</em> dans un navigateur.</p>
<h4>Avec un executable sur votre OS</h4><p><strong>Si vous avez installé NodeAtlas avec <code>npm install -g node-atlas</code></strong> vous pouvez également utiliser la commande <code>nodeatlas</code>. <code>nodeatlas</code> est un raccourci de <code>node &lt;/path/to/&gt;node-atlas/node-atlas.js</code>.</p>
<p>Placez-vous toujours avec votre invité de commande dans le dossier « /site-hello-world/ » et exécutez la commande suivante.</p>
<pre class="prettyprint source"><code>\> nodeatlas</code></pre><p><em>Note : </em>si la commande <code>nodeatlas</code> n'est pas disponible sous unix après installation (erreur quand vous la tapez), c'est surement à cause d'un problème de droit. Si vous êtes root la commande <code>chown -R root:root /usr/local/bin/</code> avant de retaper <code>npm install -g node-atlas</code> solutionnera votre problème, sinon la utilisez la commande <code>sudo npm install -g node-atlas</code>.*</p>
<h4>Via un fichier JavaScript</h4><p>Vous pouvez également utiliser NodeAtlas comme un module npm.</p>
<p><em>server.js</em></p>
<pre class="prettyprint source lang-javascript"><code>var nodeAtlas = require(&quot;node-atlas&quot;);

nodeAtlas.run();</code></pre><pre class="prettyprint source"><code>\> node server.js</code></pre><h2>Différentes configurations du webconfig.json</h2><h3>Plusieurs pages</h3><p>Ci-dessous un exemple de configuration.</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;templatesRelativePath&quot;: &quot;templates/&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        },
        &quot;/member.html&quot;: {
            &quot;template&quot;: &quot;member.htm&quot;
            &quot;postSupport&quot;: false,
        },
        &quot;/member-without-extension/&quot;: {
            &quot;template&quot;: &quot;member.htm&quot;
            &quot;getSupport&quot;: false,
        },
        &quot;about.html&quot;: {
            &quot;template&quot;: &quot;about.htm&quot;
        },
        &quot;/error.html&quot;: {
            &quot;template&quot;: &quot;error.htm&quot;,
            &quot;statusCode&quot;: 404,
            &quot;mimeType&quot;: &quot;text/plain&quot;
        }
    }
}</code></pre><p>Pour faire tourner cet ensemble de fichier :</p>
<pre class="prettyprint source"><code>templates/
— index.htm
— member.htm
— error.htm
webconfig.json</code></pre><p>aux adresses :</p>
<ul>
<li><em>http://localhost/</em> (répond à la racine)</li>
<li><em>http://localhost/member.html</em> (ne répondra pas si demandée en POST)</li>
<li><em>http://localhost/member-without-extension/</em> (ne répondra pas si demandée en GET)</li>
<li><em>http://localhost/error.html</em> (renvoi du contenu plein texte (sans balise) avec une erreur 404)</li>
</ul>
<p><em>Note : Si</em> <strong><em>templatesRelativePath</em></strong> <em>n'est pas présent dans « webconfig.js », par défaut le dossier des templates est bien</em> <strong><em>templates/</em></strong>. <strong><em>templatesRelativePath</em></strong> <em>est donc utile seulement pour changer le nom/chemin du répertoire.</em></p>
<h3>Raccourci de template</h3><p>La configuration ci-dessous est équivalente à la configuration de la section juste au dessus </p>
<pre class="prettyprint source lang-js"><code>{
    &quot;templatesRelativePath&quot;: &quot;templates/&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: &quot;index.htm&quot;,
        &quot;/member.html&quot;: {
            &quot;template&quot;: &quot;member.htm&quot;
            &quot;postSupport&quot;: false,
        },
        &quot;/member-without-extension/&quot;: {
            &quot;template&quot;: &quot;member.htm&quot;
            &quot;getSupport&quot;: false,
        },
        &quot;about.html&quot;: &quot;about.htm&quot;,
        &quot;/error.html&quot;: {
            &quot;template&quot;: &quot;error.htm&quot;,
            &quot;statusCode&quot;: 404,
            &quot;mimeType&quot;: &quot;text/plain&quot;
        }
    }
}</code></pre><p>car</p>
<pre class="prettyprint source lang-js"><code>&quot;about.html&quot;: &quot;about.htm&quot;,</code></pre><p>est un raccourci de </p>
<pre class="prettyprint source lang-js"><code>&quot;about.html&quot;: {
    &quot;template&quot;: &quot;about.htm&quot;
}</code></pre><p>Évidemment ce raccourci ne sert que si <code>template</code> est le seul paramètre à déclarer de la route.</p>
<h3>Héberger des images, polices, CSS, JS, etc.</h3><p>Vous pouvez également héberger tout un tas de fichier sur votre site dans un dossier public. Par exemple avec cette configuration :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;assetsRelativePath&quot;: &quot;assets/&quot;
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>et cet ensemble de fichiers :</p>
<pre class="prettyprint source"><code>assets/
— stylesheets/
—— common.css
— javascript/
—— common.js
— media/
—— images/
——— logo.png
templates/
— index.htm
webconfig.json</code></pre><p>vous aurez accès aux adresses :</p>
<ul>
<li><em>http://localhost/</em></li>
<li><em>http://localhost/stylesheets/common.css</em></li>
<li><em>http://localhost/javascript/common.js</em></li>
<li><em>http://localhost/media/images/logo.png</em></li>
</ul>
<p><em>Note : Si</em> <strong><em>assetsRelativePath</em></strong> <em>n'est pas présent dans « webconfig.js », par défaut le dossier public est bien</em> <strong><em>assets/</em></strong>. <strong><em>assetsRelativePath</em></strong> <em>est donc utile seulement pour changer le nom/chemin du répertoire.</em></p>
<h3>Gérer des inclusions pour éviter la redondance du code</h3><p>Vous pouvez segmenter vos codes HTML afin de ne pas répéter le code redondant comme par exemple les parties « head » et « foot » ou tout autre fragment de code :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;componentsRelativePath&quot;: &quot;components/&quot;
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        },
        &quot;/liste-des-membres/&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;
        }
    }
}</code></pre><p>avec les fichiers suivants :</p>
<pre class="prettyprint source"><code>assets/
— stylesheets/
—— common.css
— javascript/
—— common.js
components/
— head.htm
— foot.htm
templates/
— index.htm
— members.htm
webconfig.json</code></pre><p><em>components/head.htm</em></p>
<pre class="prettyprint source lang-html"><code>&lt;!DOCTYPE html>
&lt;html lang=&quot;fr-fr&quot;>
    &lt;head>
        &lt;meta charset=&quot;utf-8&quot; />
        &lt;title>Hello world&lt;/title>

        &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;stylesheets/common.css&quot; media=&quot;all&quot; />
    &lt;/head>
    &lt;body></code></pre><p><em>components/foot.htm</em></p>
<pre class="prettyprint source lang-html"><code>        &lt;script async type=&quot;text/javascript&quot; src=&quot;javascript/common.js&quot;>&lt;/script>
    &lt;/body>
&lt;/html></code></pre><p><em>templates/index.htm</em></p>
<pre class="prettyprint source lang-html"><code>    &lt;%- include('head.htm') %>

    &lt;div>
        &lt;h1>Bienvenue&lt;/h1>
        &lt;p>C'est la page d'accueil.&lt;/p>
    &lt;/div>

    &lt;%- include('foot.htm') %></code></pre><p><em>templates/members.htm</em></p>
<pre class="prettyprint source lang-html"><code>    &lt;%- include('head.htm') %>

    &lt;div>
        &lt;h1>Liste des members&lt;/h1>
        &lt;p>C'est la page des membres.&lt;/p>
    &lt;/div>

    &lt;%- include('foot.htm') %></code></pre><p>vous aurez accès aux adresses :</p>
<ul>
<li><em>http://localhost/</em></li>
<li><em>http://localhost/liste-des-membres/</em></li>
</ul>
<p><em>Note : Si</em> <strong><em>componentsRelativePath</em></strong> <em>n'est pas présent dans « webconfig.js », par défaut le dossier des includes est bien</em> <strong><em>components/</em></strong>. <strong><em>componentsRelativePath</em></strong> <em>est donc utile seulement pour changer le nom/chemin de répertoire.</em></p>
<h3>Gérer des variations au sein d'un même template</h3><p>Il est possible avec le même template et les mêmes includes de générer des pages au contenu différent (utile en mode génération d'assets HTML). Activer les variations avec la configuration suivante :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;commonVariation&quot;: &quot;common.json&quot;,
    &quot;variationsRelativePath&quot;: &quot;variations/&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;template.htm&quot;,
            &quot;variation&quot;: &quot;index.json&quot;,
        },
        &quot;/liste-des-membres/&quot;: {
            &quot;template&quot;: &quot;template.htm&quot;,
            &quot;variation&quot;: &quot;members.json&quot;,
        }
    }
}</code></pre><p>avec les fichiers suivants :</p>
<pre class="prettyprint source"><code>assets/
— stylesheets/
—— common.css
—— home.css
—— members.css
— javascript/
—— common.js
—— home.js
—— members.js
components/
— head.htm
— foot.htm
variations/
— common.json
— index.json
— members.json
templates/
— template.htm
webconfig.json</code></pre><p><em>components/head.htm</em></p>
<pre class="prettyprint source lang-html"><code>&lt;!DOCTYPE html>
&lt;html lang=&quot;fr-fr&quot;>
    &lt;head>
        &lt;meta charset=&quot;utf-8&quot; />
        &lt;title>&lt;%= specific.titlePage %>&lt;/title>

        &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;stylesheets/&lt;%= common.classCssCommon %>.css&quot; media=&quot;all&quot; />
        &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;stylesheets/&lt;%= specific.classPage %>.css&quot; media=&quot;all&quot; />
    &lt;/head>
    &lt;body class=&quot;&lt;%= specific.classPage %>&quot;></code></pre><p><em>components/foot.htm</em></p>
<pre class="prettyprint source lang-html"><code>        &lt;script async type=&quot;text/javascript&quot; src=&quot;javascript/&lt;%= common.classJsCommon %>.js&quot;>&lt;/script>
    &lt;/body>
&lt;/html></code></pre><p><em>templates/template.htm</em></p>
<pre class="prettyprint source lang-html"><code>    &lt;%- include('head.htm') %>

    &lt;div class=&quot;title&quot;>&lt;%= common.titleWebsite %>&lt;/div>

    &lt;div>
        &lt;h1>&lt;%= specific.titlePage %>&lt;/h1>
        &lt;%- specific.content %>
    &lt;/div>

    &lt;%- include('foot.htm') %></code></pre><p><em>variations/common.json</em></p>
<pre class="prettyprint source lang-js"><code>{
    &quot;titleWebsite&quot;: &quot;Titre du site&quot;,
    &quot;classCssCommon&quot;: &quot;common&quot;,
    &quot;classJsCommon&quot;: &quot;common&quot;
}</code></pre><p><em>variations/index.json</em></p>
<pre class="prettyprint source lang-js"><code>{
    &quot;titlePage&quot;: &quot;Bienvenue&quot;,
    &quot;classPage&quot;: &quot;index&quot;,
    &quot;content&quot;: &quot;&lt;p>C'est la page d'accueil.&lt;/p>&quot;
}</code></pre><p><em>variations/members.json</em></p>
<pre class="prettyprint source lang-js"><code>{
    &quot;titlePage&quot;: &quot;Liste des membres&quot;,
    &quot;classPage&quot;: &quot;members&quot;,
    &quot;content&quot;: &quot;&lt;p>C'est la page des membres.&lt;/p>&quot;
}</code></pre><p>vous aurez accès aux adresses :</p>
<ul>
<li><em>http://localhost/</em></li>
<li><em>http://localhost/liste-des-membres/</em></li>
</ul>
<p><em>Note : Si</em> <strong><em>variationsRelativePath</em></strong> <em>n'est pas présent dans « webconfig.js », par défaut le dossier des variations est bien</em> <strong><em>variations/</em></strong>. <strong><em>variationsRelativePath</em></strong> <em>est donc utile seulement pour changer le nom/chemin de répertoire.</em></p>
<h3>Gérer le multilingue</h3><h4>Toutes les langues sur le même site</h4><p>Sur le même principe, les variations peuvent être utilisées pour créer la même page, mais dans des langues différentes :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;languageCode&quot;: &quot;en-gb&quot;,
    &quot;variationsRelativePath&quot;: &quot;languages/&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;landing.htm&quot;,
            &quot;variation&quot;: &quot;landing.json&quot;
        },
        &quot;/home/&quot;: {
            &quot;template&quot;: &quot;home.htm&quot;,
            &quot;variation&quot;: &quot;home.json&quot;
        },
        &quot;/accueil/&quot;: {
            &quot;template&quot;: &quot;home.htm&quot;,
            &quot;variation&quot;: &quot;home.json&quot;,
            &quot;languageCode&quot;: &quot;fr-fr&quot;
        }
    }
}</code></pre><p><em>Note : Dans cet exemple j'ai décidé de me passer d'un fichier de variation commune, car je n'ai pas précisé de</em> <strong><em>commonVariation</em></strong>. <em>J'ai également totalement arbitrairement décidé de renommer mon dossier</em> <strong><em>variations/</em></strong> <em>en</em> <strong><em>languages/</em></strong>.</p>
<p>avec les fichiers suivants :</p>
<pre class="prettyprint source"><code>components/
— head.htm
— foot.htm
languages/
— landing.json
— en-gb
—— home.json
— fr-fr
—— home.json
templates/
— landing.htm
— home.htm
webconfig.json</code></pre><p><em>components/head.htm</em></p>
<pre class="prettyprint source lang-html"><code>&lt;!DOCTYPE html>
&lt;html lang=&quot;&lt;%= languageCode %>&quot;>
    &lt;head>
        &lt;meta charset=&quot;utf-8&quot; />
        &lt;title>&lt;%= specific.titlePage %>&lt;/title>
    &lt;/head>
    &lt;body class=&quot;&lt;%= specific.classPage %>&quot;></code></pre><p><em>components/foot.htm</em></p>
<pre class="prettyprint source lang-html"><code>    &lt;/body>
&lt;/html></code></pre><p><em>templates/landing.htm</em></p>
<pre class="prettyprint source lang-html"><code>    &lt;%- include('head.htm') %>

    &lt;select>
        &lt;% for (var i = 0; i &lt; specific.selectLabel.length; i++) { %>
        &lt;option>&lt;%= specific.selectLabel[i] %>&lt;/option>
        &lt;% } %>
    &lt;/select>

    &lt;%- include('foot.htm') %></code></pre><p><em>templates/home.htm</em></p>
<pre class="prettyprint source lang-html"><code>    &lt;%- include('head.htm') %>

    &lt;div>
        &lt;h1>&lt;%= specific.titlePage %>&lt;/h1>
        &lt;%- specific.content %>
    &lt;/div>

    &lt;%- include('foot.htm') %></code></pre><p><em>languages/landing.json</em></p>
<pre class="prettyprint source lang-js"><code>{
    &quot;titlePage&quot;: &quot;Landing&quot;,
    &quot;classPage&quot;: &quot;landing&quot;,
    &quot;selectLabel&quot;: [
        &quot;English&quot;,
        &quot;Français&quot;
    ]
}</code></pre><p><em>languages/en-gb/home.json</em></p>
<pre class="prettyprint source lang-js"><code>{
    &quot;titlePage&quot;: &quot;Welcome&quot;,
    &quot;classPage&quot;: &quot;home&quot;,
    &quot;content&quot;: &quot;&lt;p>This is a home page.&lt;/p>&quot;
}</code></pre><p><em>languages/fr-fr/home.json</em></p>
<pre class="prettyprint source lang-js"><code>{
    &quot;titlePage&quot;: &quot;Bienvenue&quot;,
    &quot;classPage&quot;: &quot;home&quot;,
    &quot;content&quot;: &quot;&lt;p>C'est la page d'accueil.&lt;/p>&quot;
}</code></pre><p>vous aurez accès aux adresses :</p>
<ul>
<li><em>http://localhost/</em></li>
<li><em>http://localhost/home/</em></li>
<li><em>http://localhost/accueil/</em></li>
</ul>
<p><em>Note : Par défaut c'est le</em> <strong><em>languageCode</em></strong> <em>racine qui conditionne la langue d'affichage du site. Cependant, spécifiquement par page on peut changer la langue avec également le</em> <strong><em>languageCode*</em></strong>. <em>Il faut également savoir que dès que le site ou une page à un</em> <strong><em>languageCode</em></strong> <em>dans la configuration, ses fichiers de variations doivent être placées dans un sous répertoire portant le nom du</em> <strong><em>languageCode</em></strong>.</p>
<h4>Utiliser seulement les variations avec le multilingue actif</h4><p>Vous avez peut-être constaté dans l'exemple précédent que le fichier <code>landing.json</code> n'était pas dans le dossier <code>en-gb/</code> ou <code>fr-fr/</code>. Cela est tout à fait possible et signifie qu'il sera utilisé dans les langues qui ne le possèdent pas dans leur dossier.</p>
<p>Aussi, quand un <code>languageCode</code> est précisé, NodeAtlas part d'abord chercher la valeur dans le fichier du dossier correspondant. Si celle-ci n'y ai pas, alors il part la chercher dans le dossier parent (celui utilisé en standard pour les variations sans multilingue).</p>
<p>Cela va vous permettre par exemple de manager la langue maître directement dans le dossier de variation. Ainsi avec l'exemple suivant :</p>
<pre class="prettyprint source"><code>...
variations/
— common.json
— home.json
— fr-fr
—— common.json
—— home.json
...</code></pre><p>vous pouvez </p>
<ul>
<li>gérer la version <code>en-gb</code> directement à la racine de <code>variations/</code> (comme NodeAtlas ne trouve rien dans <code>en-gb</code> il utilise alors les valeurs des fichiers racines) et</li>
<li>gérer la version <code>fr-fr</code> dans le dossier <code>fr-fr/</code>,</li>
</ul>
<p>ainsi, si une phrase n'est pas encore traduite dans un fichier <code>fr-fr</code>, au lieu de renvoyer une erreur, NodeAtlas renverra la version racine, soit la version <code>en-gb</code>.</p>
<h4>À chaque langue sa configuration</h4><p>Vous pouvez également décider de faire tourner chaque langue dans un « webconfig.json » différent. Avec l'ensemble de fichier suivant :</p>
<pre class="prettyprint source"><code>components/
— head.htm
— foot.htm
variations/
— landing.json
— en-gb
—— home.json
—— members.json
— fr-fr
—— home.json
—— members.json
templates/
— landing.htm
— home.htm
— members.htm
webconfig.json
webconfig.en-gb.json
webconfig.fr-fr.json</code></pre><p>vous pourriez avoir les « webconfig.json » suivant :</p>
<p><em>webconfig.json</em></p>
<pre class="prettyprint source lang-js"><code>{
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;landing.htm&quot;,
            &quot;variation&quot;: &quot;landing.json&quot;
        }
    }
}</code></pre><p><em>webconfig.en-gb.json</em></p>
<pre class="prettyprint source lang-js"><code>{
    &quot;httpPort&quot;: 81,
    &quot;urlRelativeSubPath&quot;: &quot;/english&quot;,
    &quot;languageCode&quot;: &quot;en-gb&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;home.htm&quot;,
            &quot;variation&quot;: &quot;home.json&quot;
        }, 
        &quot;/members-list/&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;,
            &quot;variation&quot;: &quot;members.json&quot;
        }
    }
}</code></pre><p><em>webconfig.fr-fr.json</em></p>
<pre class="prettyprint source lang-js"><code>{
    &quot;httpPort&quot;: 82,
    &quot;urlRelativeSubPath&quot;: &quot;/francais&quot;,
    &quot;languageCode&quot;: &quot;fr-fr&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;home.htm&quot;,
            &quot;variation&quot;: &quot;home.json&quot;
        }, 
        &quot;/liste-des-membres/&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;,
            &quot;variation&quot;: &quot;members.json&quot;
        }
    }
}</code></pre><p>et avoir accès aux adresses :</p>
<ul>
<li><em>http://localhost/</em></li>
<li><em>http://localhost:81/english/</em></li>
<li><em>http://localhost:81/english/</em></li>
<li><em>http://localhost:81/english/members-list/</em></li>
<li><em>http://localhost:82/francais/</em></li>
<li><em>http://localhost:82/francais/liste-des-membres/</em></li>
</ul>
<p>Il est ensuite possible de faire du reverse proxy avec <a href="#proxy">Bouncy</a> (par exemple) pour ramener l'ensemble des urls sur le port 80 afin d'obtenir :</p>
<ul>
<li><em>http://www.website.ext/</em></li>
<li><em>http://www.website.ext/english/</em></li>
<li><em>http://www.website.ext/english/</em></li>
<li><em>http://www.website.ext/english/members-list/</em></li>
<li><em>http://www.website.ext/francais/</em></li>
<li><em>http://www.website.ext/francais/liste-des-membres/</em></li>
</ul>
<h3>Utiliser NodeAtlas pour générer des assets HTML</h3><h4>Générer des assets HTML</h4><p>Avec la configuration suivante il est possible de générer des assets HTML du rendu de chaque page dans un fichier associé. Le fichier sera (re)créé à chaque affichage de la page dans votre navigateur.</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;htmlGenerateBeforeResponse&quot;: true,
    &quot;generatesRelativePath&quot;: &quot;generates/&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;,
            &quot;generate&quot;: &quot;/index.html&quot;
        },
        &quot;/liste-des-membres/&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;,
            &quot;generate&quot;: &quot;/members/list.html&quot;
        },
        &quot;/liste-des-membres/?foo=bar&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;,
            &quot;generate&quot;: false
        },
        &quot;/no/generate/property/&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;
        }
    }
}</code></pre><p>et l'ensemble de fichiers suivant :</p>
<pre class="prettyprint source"><code>{
assets/
— stylesheets/
—— common.css
— javascript/
—— common.js
generates/
templates/
— index.htm
— members.htm
webconfig.json
}</code></pre><p>on peut créer physiquement les assets :</p>
<pre class="prettyprint source"><code>{
generates/
— index.html
— members/
—— list.html
— no/
—— generate/
——— property &lt;== Ceci est un fichier
templates/
— index.htm
— members.htm
webconfig.json
}</code></pre><p>en se rendant aux adresses :</p>
<ul>
<li><em>http://localhost/</em></li>
<li><em>http://localhost/liste-des-membres/</em></li>
<li><em>http://localhost/no/generate/property/</em></li>
</ul>
<p><em>Note : Il n'y a pas de génération pour « /liste-des-membres/?foo=bar » car <code>generate</code> est à <code>false</code>. Utilisez cette valeur pour ignorer des routes à la génération.</em></p>
<p>La génération s'enclenche quand on affiche la page uniquement parce que <strong><em>htmlGenerateBeforeResponse</em></strong> existe et est à <strong><em>true</em></strong>. S'il est passé à <strong><em>false</em></strong> (ou enlevé) le seul moyen de générer toutes les pages du site sera via la commande <code>node &lt;/path/to/&gt;node-atlas/server.js --generate</code> qui génèrera toutes les pages d'un coup uniquement si le dossier de <code>generatesRelativePath</code> existe. Bien entendu dans tous les cas cette commande marche et permet de régénérer toutes les pages suite à un changement telle qu'une modification dans un composant appelé sur toutes les pages.</p>
<p>De plus avec <code>--generate</code>, l'intégralité du dossier <code>assetsRelativePath</code> (dossier des fichiers publiques) sera copié dans le dossier <code>generatesRelativePath</code> si les deux dossier n'ont pas un chemin identique, et que <code>generatesRelativePath</code> existe. Cela vous permet réellement d'obtenir en sortie dans le dossier de génération des pages « stand-alone » avec l'intégralité des fichiers auxquelles elles font appel (CSS / JS / Images, etc.).</p>
<p>Vous pouvez également désactiver la génération, même si un dossier <code>generatesRelativePath</code> existe dans les dossiers, avec <code>htmlGenerateEnable</code> à <code>false</code>.</p>
<p><em>Note : Si</em> <strong><em>generatesRelativePath</em></strong> <em>n'est pas présent dans « webconfig.js », par défaut le dossier des générations est bien</em> <strong><em>generates/</em></strong>. <strong><em>generatesRelativePath</em></strong> <em>est donc utile seulement pour changer le nom/chemin répertoire.</em></p>
<h4>Générer un site sans partie serveur</h4><p>Il est également possible de manager la création d'un site en simple page HTML avec la configuration suivante :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;languageCode&quot;: &quot;fr-fr&quot;,
    &quot;enableIndex&quot;: true,
    &quot;htmlGenerateBeforeResponse&quot;: true,
    &quot;generatesRelativePath&quot;: &quot;../HTML/&quot;,
    &quot;assetsRelativePath&quot;: &quot;../HTML/&quot;,
    &quot;routes&quot;: {
        &quot;/cv.html&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;,
            &quot;variation&quot;: &quot;index.json&quot;
        },
        &quot;/en/cv.html&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;,
            &quot;variation&quot;: &quot;index.json&quot;,
            &quot;languageCode&quot;: &quot;en&quot;
        }
    }
}</code></pre><p>et l'ensemble de fichiers suivant :</p>
<pre class="prettyprint source"><code>HTML/
— stylesheets/
—— common.css
— javascript/
—— common.js
engine/
— variations/
—— fr-fr/
——— index.json
—— en/
——— index.json
— templates/
—— index.htm
— webconfig.json</code></pre><p>À l'adresse <em>http://localhost/</em> s'affichera la liste des pages composants votre site (grâce à <strong>enableIndex</strong> à <strong>true</strong>).</p>
<p>Il ne restera plus qu'à, une fois votre travail terminé, admirer votre site HTML dans le dossier :</p>
<pre class="prettyprint source"><code>HTML/
— stylesheets/
—— common.css
— javascript/
—— common.js
— cv.html
— en/
—— cv.html</code></pre><h3>Utiliser NodeAtlas pour faire tourner un site (partie Back-end)</h3><p>Vous pouvez soit utiliser un contrôleur unique pour tout le site et/ou également des contrôleurs par template et variation.</p>
<p>Pour le contrôleur maître, utilisez par exemple cette configuration :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;commonController&quot;: &quot;common.js&quot;,
    &quot;controllersRelativePath&quot;: &quot;controllers/&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;,
            &quot;variation&quot;: &quot;index.json&quot;
        },
        &quot;/categories/&quot;: {
            &quot;template&quot;: &quot;categories.htm&quot;,
            &quot;variation&quot;: &quot;categories.json&quot;
        }
    }
}</code></pre><p>avec cet ensemble de fichier</p>
<pre class="prettyprint source"><code>variations/
— index.json
— categories.json
controllers/
— common.js
models/
— Article.js
— Category.js
templates/
— index.htm
— categories.htm
webconfig.json</code></pre><p>Et le fichier « common.js » contenant par exemple :</p>
<ul>
<li>De quoi charger des modules supplémentaires à NodeAtlas.</li>
<li>De quoi configurer les modules supplémentaires.</li>
</ul>
<pre class="prettyprint source lang-js"><code>// Création d'un objet global au fichier.
var website = {};



/**********************/
/* Chargement modules */
/**********************/

(function (publics) {
    &quot;use strict&quot;;

    // Chargement des modules pour ce site dans l'objet NodeAtlas.
    publics.loadModules = function (NA) {
        // Associations de chaque module pour y avoir accès partout.
        NA.modules.cookie = require('cookie');
        NA.modules.mongoose = require('mongoose');

        // Aller chercher un module spécifiquement dans le `node_modules` du site web.
        NA.modules.socketio = require(NA.websiteModulesPath + 'socket.io');

        // Aller chercher un module spécifiquement dans le `node_modules` du moteur NodeAtlas.
        NA.modules.ejs = require(NA.nodeAtlasModulesPath + 'ejs.io');

        // Ré-injection de l'objet « NodeAtlas » surchargé dans le moteur.
        return NA;
    };

}(website));



/*****************************/
/* Configuration des modules */
/*****************************/

(function (publics) {
    &quot;use strict&quot;;

    var privates = {};

    // Exemple d'utilisation de MongoDB et Mongoose.
    privates.mongooseInitialization = function (mongoose, callback) {
        // Connexion à la base « blog ».
        mongoose.connect('mongodb://127.0.0.1:27017/blog', function (error) {
            if (error) {
                console.log(&quot;La base '&quot; + address + &quot;' n'est pas accessible.&quot;);
                process.kill(process.pid);
            };

            // Suite.
            callback(mongoose);
        });

        // Gestion de connexion.
        mongoose.connection.on('error', function (error) {
            console.log('Erreur pour la connexion par défaut à Mongoose : ' + error);
        });

        // Gestion des déconnexion.
        mongoose.connection.on('disconnected', function () {
            console.log('Déconnexion de Mongoose.');
        });
        process.on('SIGINT', function (error) {
            mongoose.connection.close(function () {
                console.log(&quot;Déconnexion de Mongoose en raison de l'arrêt de l'app.&quot;);
                process.exit(0);
            });
        });
    };

    // Mise à disposition des Schémas Mongoose.
    privates.mongooseSchemas = function (mongoose) {
        publics.schema = {};

        // Chargement des Schémas.
        publics.schema.article = require('../models/Article');
        publics.schema.category = require('../models/Category');

        // Mise à disposition des Schémas.
        mongoose.model('article', website.schema.article, 'article');
        mongoose.model('category', website.schema.category, 'category');
    };

    // Exemple d'utilisation de Socket.IO.
    privates.socketIoInitialisation = function (socketio, NA, callback) {
        var optionIo = (NA.webconfig.urlRelativeSubPath) ? { path: NA.webconfig.urlRelativeSubPath + '/socket.io' } : undefined,
            io = socketio(NA.server, optionIo),
            cookie = NA.modules.cookie,
            cookieParser = NA.modules.cookieParser;

        // Synchronisation des Sessions avec Socket.IO.
        io.use(function(socket, next) {
            var handshakeData = socket.request;

            // Fallback si les cookies ne sont pas gérés.
            if (!handshakeData.headers.cookie) {
                return next(new Error('Cookie de session requis.'));
            }

            // Transformation de la String cookie en Objet JSON.
            handshakeData.cookie = cookie.parse(handshakeData.headers.cookie);

            // Vérification de la signature du cookie.
            handshakeData.cookie = cookieParser.signedCookies(handshakeData.cookie, NA.webconfig.session.secret);

            // Garder à porté l'ID de Session.
            handshakeData.sessionID = handshakeData.cookie[NA.webconfig.session.key];

            // Accepter le cookie.
            NA.sessionStore.load(handshakeData.sessionID, function (error, session) {
                if (error || !session) {
                    return next(new Error('Aucune session récupérée.'));
                } else {
                    handshakeData.session = session;                    
                    next();
                }
            });
        });

        // Suite.
        callback(io);
    };

    // Ajout d'évênements d'écoute pour un controller spécifique « index.js » (voir exemple dans le fichier d'après).
    privates.socketIoEvents = function (io, NA) {
        var params = {};

        params.io = io;
        params.NA = NA;

        // Évênements pour la page index (voir exemple dans le fichier d'après).
        require('./index').asynchrone(params);
    };

    // Configuration de tous les modules.
    publics.setConfigurations = function (NA, callback) {
        var mongoose = NA.modules.mongoose,
            socketio = NA.modules.socketio;

        // Initialisation de Mongoose.
        privates.mongooseInitialization(mongoose, function (mongoose) {

            // Injection de Schémas dans Mongoose.
            privates.mongooseSchemas(mongoose);

            // Initialisation de Socket IO.
            privates.socketIoInitialisation(socketio, NA, function (io) {

                // Écoute d'action Socket IO.
                privates.socketIoEvents(io, NA);

                // Ré-injection de l'objet « NodeAtlas » surchargé dans le moteur.
                callback(NA);                   
            });
        });

    };

}(website));



/*******************************/
/* Interception des Variations */
/*******************************/

(function (publics) {
    &quot;use strict&quot;;

    // On intervient juste avant l'assemblage complet EJS.
    publics.changeVariation = function (params, mainCallback) {
        var variation = params.variation;

        // Ici on modifie les variables de variations.
        // voir exemple dans le fichier d'après.

        // On ré-injecte les modifications.
        mainCallback(variation);
    };

}(website));



/***********************************************************/
/* Interception de la sortie HTML pour jQuery côté serveur */
/***********************************************************/

(function (publics) {
    &quot;use strict&quot;;

    // On intervient juste avant le renvoi HTML auprès du client (response).
    publics.changeDom = function (params, mainCallback) {
        var dom = params.dom;

        // Ici on peut manipuler le DOM côté serveur avant retour client.
        // voir exemple dans le fichier d'après.

        // On ré-injecte les modifications.
        mainCallback(dom);
    };

}(website));



/*************************************************************/
/* Mise à dispositions des fonction pour le moteur NodeAtlas */
/*************************************************************/

exports.loadModules = website.loadModules;
exports.setConfigurations = website.setConfigurations;
exports.changeVariation = website.changeVariation;
exports.changeDom = website.changeDom;</code></pre><p>Au lieu de se servir de <code>changeVariation</code> et <code>changeDom</code> dans le fichier <code>common.js</code> effectif pour tout le site, on peut utiliser des contrôleurs spécifiques par page. La configuration précédente devient alors :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;commonController&quot;: &quot;common.js&quot;,
    &quot;controllersRelativePath&quot;: &quot;controllers/&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;,
            &quot;controller&quot;: &quot;index.js&quot;,
            &quot;variation&quot;: &quot;index.json&quot;
        },
        &quot;/categories/&quot;: {
            &quot;template&quot;: &quot;categories.htm&quot;,
            &quot;controller&quot;: &quot;categories.js&quot;,
            &quot;variation&quot;: &quot;categories.json&quot;
        }
    }
}</code></pre><p>avec cet ensemble de fichier</p>
<pre class="prettyprint source"><code>variations/
— index.json
— categories.json
controllers/
— modules/
—— list-of-article.js/
— common.js
- index.js
- categories.js
models/
— Article.js
— Category.js
templates/
— index.htm
— categories.htm
webconfig.json</code></pre><p>avec un fichier « index.js » contenant par exemple :</p>
<ul>
<li>De quoi modifier les variations dynamiquement avant affichage.</li>
<li>De quoi faire des modifications jQuery côté serveur.</li>
<li>De quoi faire des échanges asynchrones avec Socket.IO.</li>
</ul>
<pre class="prettyprint source lang-js"><code>var website = {};



/*******************************/
/* Interception des Variations */
/*******************************/

(function (publics) {
    &quot;use strict&quot;;

    var privates = {};

    // On charge une fonction ou un ensemble de fonctions.
    privates.listOfArticles = require('./modules/list-of-articles');

    // On intervient juste avant l'assemblage complet EJS.
    publics.changeVariation = function (params, mainCallback) {
        var variation = params.variation,
            mongoose = params.NA.modules.mongoose,
            Article = mongoose.model('article');


        // Interception possible de toutes les variables de « variations/common.js ».
        console.log(variation.common.title); // Renvoi le titre stocké dans « variations/common.js ».
        variation.common.title = &quot;Nouveau title&quot;; // Redéfini un titre.
        console.log(variation.common.title); // Renvoi « Nouveau title » et est accessible côté template via `&lt;%= common.title %>`. 

        // Interception possible de toutes les variables de « variations/index.js » (car on est dans le spécific « index.js »).
        variation.specific.title = &quot;Nouveau title&quot;; // Redéfini un titre qui est accessible côté template via `&lt;%= specific.title %>`.
        variation.specific.newProperty = &quot;Nouvelle propriété&quot;; // Défini une propriété n'existant pas initialement dans le fichier de variation qui est accessible côté template via `&lt;%= specific.newProperty %>`.

        // Interception possible de la configuration de la page courante.
        console.log(variation.currentRoute) // Retourne « / » pour « index.js », « /categories/ » pour « categories.js », « /categories/:category/ » pour « category-detail.js », etc.

        // On test une variable créer de toute pièce dans le webconfig.
        if (variation.webconfig._websiteIsClosed) { 
            // La page sera en 404.
            variation.currentRouteParameters.statusCode = 404;
        } else {
            // La page sera en 200.
            variation.currentRouteParameters.statusCode = 200;
        }

        // Création d'un nouvel ensemble de variation dynamique pour les templates.
        variation.backend = {}; // Propriétés accessibles via « &lt;%= backend.&lt;propriétés> %> ».p

        privates.listOfArticles(Article, function (listOfArticles) {

            // Disponibilité des données des articles côté template.
            variation.backend.articles = listOfArticles; // « &lt;%= backend.articles.&lt;propriétés> %> ».

            // On ré-injecte les modifications.
            mainCallback(variation);
        });
    };

}(website));



/***********************************************************/
/* Interception de la sortie HTML pour jQuery côté serveur */
/***********************************************************/

(function (publics) {
    &quot;use strict&quot;;

    // On intervient juste avant le renvoi HTML auprès du client (response).
    publics.changeDom = function (params, mainCallback) {
        var dom = params.dom,
            NA = params.NA,
            cheerio = NA.modules.cheerio, // Récupération de jsdom pour parcourir le DOM avec jQuery.
            $ = cheerio.load(dom); // On charge les données pour les manipuler comme un DOM.

        // Après tous les h2 de la sortie HTML « dom »,
        $(&quot;h2&quot;).each(function (i) {
            var $this = $(this);

            // ...on créé une div,
            $this.after(
                // ... on injecte le contenu du h2 dans la div,
                $(&quot;&lt;div>&quot;).html($this.html())
            )
            // ...et supprime le h2.
            $this.remove();
        });

        // On re-créer une nouvelle sortie HTML avec nos modifications.
        dom = $.html()

        // On ré-injecte les modifications.
        mainCallback(dom);
    };

}(website));



/***********************************************/
/* Gestion des évênements Socket.IO asynchrone */
/***********************************************/

(function (publics) {
    &quot;use strict&quot;;

    var privates = {};

    // Intégralité des actions Websocket possible pour ce template.
    publics.asynchrone = function (params) {
        var io = params.io,
            mongoose = params.NA.modules.mongoose,
            marked = params.NA.modules.marked,
            Article = mongoose.model('article'),
            renderer = new marked.Renderer();

        // Dès qu'on a un lien valide entre le client et notre back...
        io.sockets.on('connection', function (socket) {
            var sessionID = socket.request.sessionID,
                session = socket.request.session;

            // ...rester à l'écoute de la demande « create-article-button »...
            socket.on('create-article-button', function (data) {

                // ...et répondre à cette demande en créant un nouvelle article si elle vient
                // avec les information envoyées via « data ».
                var article = new Article({
                    _id: mongoose.Types.ObjectId(),
                    title: data.title,
                    urn: data.urn,
                });

                // Si l'utilisateur est connecté.
                if (session.account) {

                    // ...on sauve l'article en base.
                    article.save(function (error) {
                        if (error) { 
                            throw error;
                        }

                        // Et on répond à tous les clients avec un jeu de donnée dans data.
                        io.sockets.emit('create-article-button', data);
                    });
                }
            });
        });
    };

}(website));



/*************************************************************/
/* Mise à dispositions des fonction pour le moteur NodeAtlas */
/*************************************************************/

exports.changeVariation = website.changeVariation;
exports.changeDom = website.changeDom;
exports.asynchrone = website.asynchrone; // Utilisé non pas par « NodeAtlas » mais par « common.js » (voir fichier précédent).</code></pre><p><em>Note : Si</em> <strong><em>controllersRelativePath</em></strong> <em>n'est pas présent dans « webconfig.js », par défaut le dossier des controlleurs est bien</em> <strong><em>controllers/</em></strong>. <strong><em>controllersRelativePath</em></strong> <em>est donc utile seulement pour changer le nom/chemin du répertoire.</em></p>
<h3>Changer les paramètres d'url</h3><p>Par défaut, si vous utilisez la configuration suivante :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>cela est identique à utiliser celle-ci :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;httpHostname&quot;: &quot;localhost&quot;,
    &quot;httpPort&quot;: 80,
    &quot;httpSecure&quot;: false,
    &quot;urlRelativeSubPath&quot;: &quot;&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>et vous pourrez accéder à l'url : <em>http://localhost/</em>.</p>
<p>Changez alors la configuration en ceci :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;httpHostname&quot;: &quot;127.0.0.1&quot;,
    &quot;httpPort&quot;: 7777,
    &quot;httpSecure&quot;: true,
    &quot;urlRelativeSubPath&quot;: &quot;/sub/folder&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>pour accéder à : <em>https://127.0.0.1:7777/sub/folder/</em></p>
<h3>Créer ses propres variables de webconfig</h3><p>Imaginons deux webconfigs dans lesquels nous allons créer nos propres variables comme suit :</p>
<ol>
<li>« webconfig.json »</li>
</ol>
<pre class="prettyprint source lang-js"><code>{
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }, 
    &quot;_minified&quot;: &quot;&quot;
}</code></pre><ol>
<li>« webconfig.prod.json »</li>
</ol>
<pre class="prettyprint source lang-js"><code>{
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }, 
    &quot;_minified&quot;: &quot;.min&quot;
}</code></pre><p>avec cet ensemble de fichiers</p>
<pre class="prettyprint source"><code>assets/
— stylesheets/
—— common.css
—— common.min.css
— javascript/
—— common.js
—— common.min.js
templates/
— index.htm
webconfig.json
webconfig.prod.json</code></pre><p>et « index.htm » contenant :</p>
<pre class="prettyprint source lang-html"><code>&lt;!DOCTYPE html>
&lt;html lang=&quot;fr-fr&quot;>
    &lt;head>
        &lt;meta charset=&quot;utf-8&quot; />
        &lt;title>Hello world&lt;/title>
        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;stylesheets/common&lt;%= webconfig._minified %>.css&quot; />
    &lt;/head>
    &lt;body>
        &lt;div>Ceci est un test de récupération de ressources minifiées/non-minifiées.&lt;/div>
        &lt;script type=&quot;text/javascript&quot; src=&quot;javascript/common&lt;%= webconfig._minified %>.js&quot;>&lt;/script>
    &lt;/body>
&lt;/html></code></pre><p>En lançant (depuis le dossier du site) la commande :</p>
<pre class="prettyprint source"><code>\> node &lt;/path/to/>node-atlas/node-atlas.js</code></pre><p>Nous aurons à l'adresse « http://localhost/ » la sortie suivante avec les fichiers non minifiés :</p>
<pre class="prettyprint source lang-html"><code>&lt;!DOCTYPE html>
&lt;html lang=&quot;fr-fr&quot;>
    &lt;head>
        &lt;meta charset=&quot;utf-8&quot; />
        &lt;title>Hello world&lt;/title>
        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;stylesheets/common.css&quot; />
    &lt;/head>
    &lt;body>
        &lt;div>Ceci est un test de récupération de ressources minifiées/non-minifiées.&lt;/div>
        &lt;script type=&quot;text/javascript&quot; src=&quot;javascript/common.js&quot;>&lt;/script>
    &lt;/body>
&lt;/html></code></pre><p>Cependant en lançant la commande :</p>
<pre class="prettyprint source"><code>\> node &lt;/path/to/>node-atlas/server.js --webconfig webconfig.prod.json</code></pre><p>Nous aurons à l'adresse « http://localhost/ » la sortie suivante avec les fichiers minifiés :</p>
<pre class="prettyprint source lang-html"><code>&lt;!DOCTYPE html>
&lt;html lang=&quot;fr-fr&quot;>
    &lt;head>
        &lt;meta charset=&quot;utf-8&quot; />
        &lt;title>Hello world&lt;/title>
        &lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;stylesheets/common.min.css&quot; />
    &lt;/head>
    &lt;body>
        &lt;div>Ceci est un test de récupération de ressources minifiées/non-minifiées.&lt;/div>
        &lt;script type=&quot;text/javascript&quot; src=&quot;javascript/common.min.js&quot;>&lt;/script>
    &lt;/body>
&lt;/html></code></pre><p><em>Note : Il vaut mieux préfixer ses variables personnelles avec « _ » pour éviter des conflits avec des variables de configuration existantes ou futures.</em></p>
<h3>Gérer le routage (Url Rewriting)</h3><p>Bien que vous puissiez paramétrer des urls statiques, vous pouvez également paramétrer une écoute d'url dynamiques !</p>
<h4>Standard</h4><p>Avec la configuration suivante :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;routes&quot;: {
        &quot;/liste-des-membres/:member/&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;
        },
        &quot;/liste-des-membres/&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;
        },
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>vous pourrez accéder à :</p>
<ul>
<li><em>http://localhost/</em></li>
<li><em>http://localhost/liste-des-membres/</em></li>
<li><em>http://localhost/liste-des-membres/toto/</em></li>
<li><em>http://localhost/liste-des-membres/bob-eponge99/</em></li>
<li><em>http://localhost/liste-des-membres/node-atlas/</em></li>
<li><em>http://localhost/liste-des-membres/etc/</em></li>
</ul>
<p>et récupérer les valeurs de <code>:member</code> dans le <code>changeVariation</code> (common et specific).</p>
<pre class="prettyprint source lang-js"><code>exports.changeVariation = function (params, mainCallback) {
    var variation = params.variation;

    console.log(variation.params.member); 
    // \> 'toto', 'bob-eponge99', 'node-atlas' ou 'etc'.

    mainCallback(variation);
}</code></pre><p>Les règles de création d'url dynamique sont celles de <a href="http://expressjs.com/4x/api.html#req.params">Express.js</a>.</p>
<h4>Expressions Régulières</h4><p>Vous pouvez également activer les expressions régulières pour un chemin précis avec <code>regExp</code>. Si celui-ci vaut <code>true</code>, le précédent mode ne fonctionne plus et vous passez en mode Expression Régulière. Si <code>regExp</code> est une chaine de caractère, celle-ci fait office de flag (g, i, m ou y).</p>
<p>Voyez la configuration suivante :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;routes&quot;: {
        &quot;/liste-des-membres/([-a-z0-9]+)/?&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;,
            &quot;regExp&quot;: &quot;g&quot;
        },
        &quot;/liste-des-membres/?&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;,
            &quot;regExp&quot;: true
        },
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>vous pourrez accéder à :</p>
<ul>
<li><em>http://localhost/</em></li>
<li><em>http://localhost/liste-des-membres/</em> <em>(ou <em>https://localhost/liste-des-membres</em>)</em></li>
<li><em>http://localhost/liste-des-membres/toto/</em> <em>(ou <em>https://localhost/liste-des-membres/toto</em>)</em></li>
<li><em>http://localhost/liste-des-membres/bob-eponge99/</em> <em>(ou <em>https://localhost/liste-des-membres/bob-eponge99</em>)</em></li>
<li><em>http://localhost/liste-des-membres/node-atlas/</em> <em>(ou <em>https://localhost/liste-des-membres/node-atlas</em>)</em></li>
<li><em>http://localhost/liste-des-membres/etc/</em> <em>(ou <em>https://localhost/liste-des-membres/etc</em>)</em></li>
</ul>
<p>et récupérer les valeurs de <code>([-a-z0-9]+)</code> dans le <code>changeVariation</code> (common et specific).</p>
<pre class="prettyprint source lang-js"><code>exports.changeVariation = function (params, mainCallback) {
    var variation = params.variation;

    if (variation.params && variation.params[0]) { variation.params.member = variation.params[0]; }
    // variation.params[1] pour le deuxième match, etc...

    console.log(variation.params.member); 
    // \> 'toto', 'bob-eponge99', 'node-atlas' ou 'etc'.

    mainCallback(variation);
}</code></pre><p>Les règles de création d'url dynamique avec <code>regExp</code> sont celles des <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/RegExp">RegExp JavaScript</a>.</p>
<h4>Routage dans un fichier partagé</h4><p>Afin de ne pas ré-écrire une longue liste de route dans un fichier <code>webconfig.json</code> à destination de votre environnement de développement et <code>webconfig.prod.json</code> à destination de votre environnement de production, vous pouvez mutaliser la déclaration des routes dans un fichier de votre choix. Par convention, c'est le fichier <code>routes.json</code>. </p>
<p>Par exemple :</p>
<p>L'ensemble de fichier suivant</p>
<pre class="prettyprint source"><code>templates/
— index.htm
webconfig.json
webconfig.prod.json</code></pre><p>avec <code>webconfig.json</code></p>
<pre class="prettyprint source lang-json"><code>{
    &quot;httpPort&quot;: 7777,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>et avec <code>webconfig.prod.json</code></p>
<pre class="prettyprint source lang-json"><code>{
    &quot;httpPort&quot;: 7776,
    &quot;httpHostname&quot;: &quot;blog.lesieur.name&quot;,
    &quot;urlPort&quot;: 80,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>pourrait devenir l'ensemble de fichier suivant </p>
<pre class="prettyprint source"><code>templates/
— index.htm
routes.json
webconfig.json
webconfig.prod.json</code></pre><p>avec <code>webconfig.json</code></p>
<pre class="prettyprint source lang-json"><code>{
    &quot;httpPort&quot;: 7777,
    &quot;routes&quot;: &quot;routes.json&quot;
}</code></pre><p>avec <code>webconfig.prod.json</code></p>
<pre class="prettyprint source lang-json"><code>{
    &quot;httpPort&quot;: 7776,
    &quot;httpHostname&quot;: &quot;blog.lesieur.name&quot;,
    &quot;urlPort&quot;: 80,
    &quot;routes&quot;: &quot;routes.json&quot;
}</code></pre><p>et <code>routes.json</code></p>
<pre class="prettyprint source lang-json"><code>{
    &quot;/&quot;: {
        &quot;template&quot;: &quot;index.htm&quot;
    }
}</code></pre><p><em>Note : Vous pouvez vous créer plusieurs fichier de route comme <code>routes.en.json</code> et <code>routes.fr.json</code> et associer chacun d'eux dans un ensemble de webconfig paramètrer pour faire tourner un site dans diverses langues.</em></p>
<h3>Gérer les pages inexistantes</h3><h4>Écouter toutes les urls, même les adresses du dossier <code>assetsRelativePath</code></h4><p>Pour afficher une page personnalisée quand une ressource n'est pas trouvée il faut :</p>
<ol>
<li>Préparer une page 404.</li>
<li>Remplir le paramètre <code>pageNotFound</code> avec comme <code>value</code> la <code>key</code> de la page 404 préparée.</li>
</ol>
<p>Voyez l'exemple ci-dessous :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;pageNotFound&quot;: &quot;/pages-inexistantes/&quot;,
    &quot;routes&quot;: {
        &quot;/liste-des-membres/&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;
        },
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        },
        &quot;/pages-inexistantes/&quot;: {
            &quot;template&quot;: &quot;error.htm&quot;,
            &quot;statusCode&quot;: 404
        }
    }
}</code></pre><p>vous pourrez accéder à :</p>
<ul>
<li><em>http://localhost/cette-page-n-existe-pas.html</em></li>
<li><em>http://localhost/elle/non/plus/</em></li>
<li><em>http://localhost/etc</em></li>
</ul>
<h4>Page d'erreur multilingue</h4><p>Il vous suffit de créer une nouvelle route finissant par <code>*</code> dans la langue souhaitée.</p>
<p>Voyez l'exemple ci-dessous :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;pageNotFound&quot;: &quot;/pages-inexistantes/&quot;,
    &quot;languageCode&quot;: &quot;fr-fr&quot;,
    &quot;routes&quot;: {
        &quot;/liste-des-membres/&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;,
            &quot;variation&quot;: &quot;members.json&quot;
        },
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;,
            &quot;variation&quot;: &quot;index.json&quot;
        },
        &quot;/pages-inexistantes/&quot;: {
            &quot;template&quot;: &quot;error.htm&quot;,
            &quot;variation&quot;: &quot;error.json&quot;,
            &quot;statusCode&quot;: 404
        },
        &quot;/english/list-of-members/&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;,
            &quot;languageCode&quot;: &quot;en-gb&quot;,
            &quot;variation&quot;: &quot;members.json&quot;
        },
        &quot;/english/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;,
            &quot;languageCode&quot;: &quot;en-gb&quot;,
            &quot;variation&quot;: &quot;index.json&quot;
        },
        &quot;/english/*&quot;: {
            &quot;template&quot;: &quot;error.htm&quot;,
            &quot;languageCode&quot;: &quot;en-gb&quot;,
            &quot;variation&quot;: &quot;error.json&quot;,
            &quot;statusCode&quot;: 404
        }
    }
}</code></pre><h3>Gérer les redirections</h3><p>Pour aller à une autre adresse (redirection 301 ou 302) quand vous arrivez à une url il faut utiliser le paramètre <code>redirect</code>.</p>
<p><em>Note : si vous ne précisez pas un <code>statusCode</code>, la redirection ne se fera pas. Le <code>statusCode</code> est obligatoire.</em></p>
<h4>En statique</h4><p>Voyez l'exemple ci-dessous :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;routes&quot;: {
        &quot;/liste-des-membres/&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;
        },
        &quot;/liste-des-membres&quot;: {
            &quot;redirect&quot;: &quot;/liste-des-membres/&quot;,
            &quot;statusCode&quot;: 301,
        },
        &quot;/aller-sur-node-atlas/&quot;: {
            &quot;redirect&quot;: &quot;http://haeresis.github.io/NodeAtlas/&quot;,
            &quot;statusCode&quot;: 302,
        },
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>Vous serez redirigé :</p>
<ul>
<li>sur <code>http://localhost/liste-des-membres/</code> quand vous accéderez à <code>http://localhost/liste-des-membres</code> avec une entête <em>redirection permanente</em>.</li>
<li>sur <code>http://haeresis.github.io/NodeAtlas/</code> quand vous accéderez à <code>http://localhost/aller-sur-node-atlas/</code> avec une entête <em>redirection temporaire</em>.</li>
</ul>
<h4>En dynamique</h4><p>Voyez l'exemple ci-dessous :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;routes&quot;: {
        &quot;/liste-des-membres/:member/&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;
        },
        &quot;/liste-des-membres/:member&quot;: {
            &quot;redirect&quot;: &quot;/membres/:member/&quot;
            &quot;statusCode&quot;: 301
        },
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>Vous serez redirigé sur <code>http://localhost/liste-des-membres/haeresis/</code> quand vous accéderez à <code>http://localhost/liste-des-membres/haeresis</code> avec une entête <em>redirection permanente</em>.</p>
<h4>Avec expressions régulières</h4><p>Voyez l'exemple ci-dessous :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;routes&quot;: {
        &quot;/membres/([-a-z0-9]+)/&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;,
            &quot;regExp&quot;: true
        },
        &quot;/liste-des-membres/([-a-z0-9]+)/&quot;: {
            &quot;redirect&quot;: &quot;/membres/$0$/&quot;
            &quot;statusCode&quot;: 301,
            &quot;regExp&quot;: true
        },
        &quot;/liste-des-membres/&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;
        },
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>Vous serez redirigé sur <code>http://localhost/membres/haeresis/</code> quand vous accéderez à <code>http://localhost/liste-des-membres/haeresis/</code> avec une entête <em>redirection permanente</em>.</p>
<p>Pour le second <em>match</em> utilisez $1$, pour le troisième $2$, etc.</p>
<h3>Faire tourner le site en HTTPs</h3><p>Il est très simple de faire tourner une instance de NodeAtlas avec le protocol HTTPs. Pour cela il suffit de créer, par exemple un dossier <code>security</code> dans lequel vous allez placer vos fichier <code>server.key</code> et <code>server.crt</code> afin d'alimenter le protocol.</p>
<p>Il ne vous reste plus qu'à utiliser la configuration suivante :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;httpSecure&quot;: true,
    &quot;httpSecureRelativeKeyPath&quot;: &quot;security/server.key&quot;
    &quot;httpSecureRelativeCertificatePath&quot;: &quot;security/server.crt&quot;
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>Vous pouvez également, si —comme c'est le cas ici— vos deux fichiers Key et Certificate portent le même nom, utiliser cette configuration : </p>
<pre class="prettyprint source lang-js"><code>{
    &quot;httpSecure&quot;: &quot;security/server&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><h3>Minifier les CSS/JS</h3><p>Vous pouvez automatiquement générer des fichiers CSS et JS minifiés et offusqués en créant des Bundles en référençant les groupes de fichiers d'entré par leur chemin d'accès et le chemin du fichier de sortie. Vous pouvez bien entendu en faire autant que vous le souhaitez. La gérération des fichiers se fait à chaque démarrage de NodeAtlas que ce soit en tant que serveur ou via la commande <code>--generate</code> pour peut qu'un Bundle existe dans le Webconfig.</p>
<h4>Créer des Bundles</h4><p>Avec la configuration suivante :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;bundles&quot;: {
        &quot;javascript&quot;: {
            &quot;javascript/boot.min.js&quot;: [
                &quot;javascript/modernizr.js&quot;,
                &quot;javascript/yepnot.js&quot;,
                &quot;javascript/html5Shiv.js&quot;
            ],
            &quot;javascript/framework.min.js&quot;: [
                &quot;javascript/jquery.js&quot;,
                &quot;javascript/jquery-ui.js&quot;,
                &quot;javascript/prettify.js&quot;,
                &quot;javascript/prettify/run_prettify.js&quot;
            ],
            &quot;javascript/common.min.js&quot;: [
                &quot;javascript/components/extended-format-date.js&quot;,
                &quot;javascript/common.js&quot;
            ]
        },
        &quot;stylesheets&quot;: {
            &quot;stylesheets/common.min.css&quot;: [
                &quot;stylesheets/common.css&quot;,
                &quot;stylesheets/common-min780.css&quot;,
                &quot;stylesheets/common-min1160.css&quot;
            ]
        }
    },
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>et l'ensemble de fichier suivant :</p>
<pre class="prettyprint source"><code>assets/
— stylesheets/
—— common.css
—— common-min780.css
—— common-min1160.css
— javascript/
—— modernizr.js
—— yepnot.js
—— html5Shiv.js
—— jquery.js
—— jquery-ui.js
—— prettify.js
—— prettify/run_prettify.js
—— components/extended-format-date.js
—— common.js
templates/
— index.htm
webconfig.json</code></pre><p>vous obtiendrez les nouveaux fichiers suivant :</p>
<pre class="prettyprint source"><code>assets/
— stylesheets/
—— common.css
—— common-min780.css
—— common-min1160.css
—— common.min.css     &lt;= nouveau fichier
— javascript/
—— modernizr.js
—— yepnot.js
—— html5Shiv.js
—— jquery.js
—— jquery-ui.js
—— prettify.js
—— prettify/run_prettify.js
—— components/extended-format-date.js
—— common.js
—— boot.min.js        &lt;= nouveau fichier
—— framework.min.js   &lt;= nouveau fichier
—— common.min.js      &lt;= nouveau fichier
templates/
— index.htm
webconfig.json</code></pre><h4>Bundles dans un fichier partagé</h4><p>Afin de ne pas ré-écrire une longue liste de configuration de Bundles dans un fichier <code>webconfig.json</code> à destination de votre environnement de développement et <code>webconfig.prod.json</code> à destination de votre environnement de production, vous pouvez mutaliser la déclaration des fichiers dans un fichier de votre choix. Par convention, c'est le fichier <code>bundles.json</code>. </p>
<p>Par exemple :</p>
<p>L'ensemble de fichier suivant</p>
<pre class="prettyprint source"><code>assets/
— stylesheets/
—— common.css
—— common-min780.css
—— common-min1160.css
— javascript/
—— modernizr.js
—— yepnot.js
—— html5Shiv.js
—— jquery.js
—— jquery-ui.js
—— prettify.js
—— prettify/run_prettify.js
—— components/extended-format-date.js
—— common.js
templates/
— index.htm
webconfig.json
webconfig.prod.json</code></pre><p>avec <code>webconfig.json</code></p>
<pre class="prettyprint source lang-json"><code>{
    &quot;httpPort&quot;: 7777,
    &quot;bundles&quot;: {
        &quot;javascript&quot;: {
            &quot;javascript/boot.min.js&quot;: [
                &quot;javascript/modernizr.js&quot;,
                &quot;javascript/yepnot.js&quot;,
                &quot;javascript/html5Shiv.js&quot;
            ],
            &quot;javascript/framework.min.js&quot;: [
                &quot;javascript/jquery.js&quot;,
                &quot;javascript/jquery-ui.js&quot;,
                &quot;javascript/prettify.js&quot;,
                &quot;javascript/prettify/run_prettify.js&quot;
            ],
            &quot;javascript/common.min.js&quot;: [
                &quot;javascript/components/extended-format-date.js&quot;,
                &quot;javascript/common.js&quot;
            ]
        },
        &quot;stylesheets&quot;: {
            &quot;stylesheets/common.min.css&quot;: [
                &quot;stylesheets/common.css&quot;,
                &quot;stylesheets/common-min780.css&quot;,
                &quot;stylesheets/common-min1160.css&quot;
            ]
        }
    },
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>et avec <code>webconfig.prod.json</code></p>
<pre class="prettyprint source lang-json"><code>{
    &quot;httpPort&quot;: 7776,
    &quot;httpHostname&quot;: &quot;blog.lesieur.name&quot;,
    &quot;urlPort&quot;: 80,
    &quot;bundles&quot;: {
        &quot;javascript&quot;: {
            &quot;javascript/boot.min.js&quot;: [
                &quot;javascript/modernizr.js&quot;,
                &quot;javascript/yepnot.js&quot;,
                &quot;javascript/html5Shiv.js&quot;
            ],
            &quot;javascript/framework.min.js&quot;: [
                &quot;javascript/jquery.js&quot;,
                &quot;javascript/jquery-ui.js&quot;,
                &quot;javascript/prettify.js&quot;,
                &quot;javascript/prettify/run_prettify.js&quot;
            ],
            &quot;javascript/common.min.js&quot;: [
                &quot;javascript/components/extended-format-date.js&quot;,
                &quot;javascript/common.js&quot;
            ]
        },
        &quot;stylesheets&quot;: {
            &quot;stylesheets/common.min.css&quot;: [
                &quot;stylesheets/common.css&quot;,
                &quot;stylesheets/common-min780.css&quot;,
                &quot;stylesheets/common-min1160.css&quot;
            ]
        }
    },
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>pourrait devenir l'ensemble de fichier suivant </p>
<pre class="prettyprint source"><code>assets/
— stylesheets/
—— common.css
—— common-min780.css
—— common-min1160.css
— javascript/
—— modernizr.js
—— yepnot.js
—— html5Shiv.js
—— jquery.js
—— jquery-ui.js
—— prettify.js
—— prettify/run_prettify.js
—— components/extended-format-date.js
—— common.js
templates/
— index.htm
bundles.json
webconfig.json
webconfig.prod.json</code></pre><p>avec <code>webconfig.json</code></p>
<pre class="prettyprint source lang-json"><code>{
    &quot;httpPort&quot;: 7777,
    &quot;bundles&quot;: &quot;bundles.json&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>avec <code>webconfig.prod.json</code></p>
<pre class="prettyprint source lang-json"><code>{
    &quot;httpPort&quot;: 7776,
    &quot;httpHostname&quot;: &quot;blog.lesieur.name&quot;,
    &quot;urlPort&quot;: 80,
    &quot;bundles&quot;: &quot;bundles.json&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>et <code>bundles.json</code></p>
<pre class="prettyprint source lang-json"><code>{
    &quot;javascript&quot;: {
        &quot;javascript/boot.min.js&quot;: [
            &quot;javascript/modernizr.js&quot;,
            &quot;javascript/yepnot.js&quot;,
            &quot;javascript/html5Shiv.js&quot;
        ],
        &quot;javascript/framework.min.js&quot;: [
            &quot;javascript/jquery.js&quot;,
            &quot;javascript/jquery-ui.js&quot;,
            &quot;javascript/prettify.js&quot;,
            &quot;javascript/prettify/run_prettify.js&quot;
        ],
        &quot;javascript/common.min.js&quot;: [
            &quot;javascript/components/extended-format-date.js&quot;,
            &quot;javascript/common.js&quot;
        ]
    },
    &quot;stylesheets&quot;: {
        &quot;stylesheets/common.min.css&quot;: [
            &quot;stylesheets/common.css&quot;,
            &quot;stylesheets/common-min780.css&quot;,
            &quot;stylesheets/common-min1160.css&quot;
        ]
    }
}</code></pre><p><em>Note : il est possible de désactiver les Bundles en ne les incluant pas dans le <code>webconfig</code> en question.</em></p>
<h4>Désactiver des Bundles</h4><p>Il est également possible de ne pas executer la minification au démarage d'un site web avec NodeAtlas avec les propriétés <code>&quot;stylesheetsBundlesEnable&quot;: false</code> et <code>&quot;javascriptBundlesEnable&quot;: false</code> pour chaque type de Bundle.</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;stylesheetsBundlesEnable&quot;: false,
    &quot;javascriptBundlesEnable&quot;: false,
    &quot;bundles&quot;: {
        &quot;javascript&quot;: {
            &quot;javascript/boot.min.js&quot;: [
                &quot;javascript/modernizr.js&quot;,
                &quot;javascript/yepnot.js&quot;,
                &quot;javascript/html5Shiv.js&quot;
            ],
            &quot;javascript/framework.min.js&quot;: [
                &quot;javascript/jquery.js&quot;,
                &quot;javascript/jquery-ui.js&quot;,
                &quot;javascript/prettify.js&quot;,
                &quot;javascript/prettify/run_prettify.js&quot;
            ],
            &quot;javascript/common.min.js&quot;: [
                &quot;javascript/components/extended-format-date.js&quot;,
                &quot;javascript/common.js&quot;
            ]
        },
        &quot;stylesheets&quot;: {
            &quot;stylesheets/common.min.css&quot;: [
                &quot;stylesheets/common.css&quot;,
                &quot;stylesheets/common-min780.css&quot;,
                &quot;stylesheets/common-min1160.css&quot;
            ]
        }
    },
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p><em>Note : si vos bundles sont dans un fichier partagé, vous pouvez également les désactiver simplement en retirand la ligne <code>&quot;bundles&quot;: &quot;bundles.json&quot;</code>.</em></p>
<h4>Ré-générer les Bundles avant chaque rendu de page</h4><p>De manière à toujours tester vos page avec les fichiers minifiés, vous pouvez demander à ce qu'ils soient régénérés avant chaque affichage de page avec les propriétés <code>&quot;stylesheetsBundlesBeforeResponse&quot;: true</code> et <code>&quot;javascriptBundlesBeforeResponse&quot;: true</code> pour chaque type de Bundle.</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;stylesheetsBundlesBeforeResponse&quot;: false,
    &quot;javascriptBundlesBeforeResponse&quot;: false,
    &quot;bundles&quot;: {
        &quot;javascript&quot;: {
            &quot;javascript/boot.min.js&quot;: [
                &quot;javascript/modernizr.js&quot;,
                &quot;javascript/yepnot.js&quot;,
                &quot;javascript/html5Shiv.js&quot;
            ],
            &quot;javascript/framework.min.js&quot;: [
                &quot;javascript/jquery.js&quot;,
                &quot;javascript/jquery-ui.js&quot;,
                &quot;javascript/prettify.js&quot;,
                &quot;javascript/prettify/run_prettify.js&quot;
            ],
            &quot;javascript/common.min.js&quot;: [
                &quot;javascript/components/extended-format-date.js&quot;,
                &quot;javascript/common.js&quot;
            ]
        },
        &quot;stylesheets&quot;: {
            &quot;stylesheets/common.min.css&quot;: [
                &quot;stylesheets/common.css&quot;,
                &quot;stylesheets/common-min780.css&quot;,
                &quot;stylesheets/common-min1160.css&quot;
            ]
        }
    },
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p><em>Note : ceci n'est pas conseillé en production car cela ralenti les réponses des pages.</em></p>
<h3>Générer les CSS avec Less</h3><p>Vous pouvez utiliser le préprocesseur Less pour créer vos CSS. Le fonctionnement est le suivant : à chaque fois qu'une requête CSS est effectuée, si un équivalent Less existe il est lu et celui-ci génère le CSS. Une fois l'opération effectuée, on renvoi le CSS demandée.</p>
<p>Avec la structure suivante :</p>
<pre class="prettyprint source"><code>assets/
— stylesheets
—— common.less
templates/
— index.htm
webconfig.json</code></pre><p>ainsi que le webconfig suivante :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;enableLess&quot;: true,
    &quot;routes&quot;: {
        &quot;/&quot;: &quot;index.htm&quot;
    }
}</code></pre><p>et le contenu suivant dans :</p>
<p><em>templates/index.htm</em></p>
<pre class="prettyprint source lang-html"><code>&lt;!DOCTYPE html>
&lt;html lang=&quot;en&quot;>
    &lt;head>
        &lt;meta charset=&quot;UTF-8&quot;>
        &lt;title>Less Test&lt;/title>
        &lt;link rel=&quot;stylesheet&quot; href=&quot;stylesheets/common.css&quot;>
    &lt;/head>
    &lt;body>
        &lt;p>Test&lt;/p>
    &lt;/body>
&lt;/html></code></pre><p><em>assets/stylesheets/common.less</em></p>
<pre class="prettyprint source lang-css"><code>p {
    color: #f00;
}</code></pre><p>vous générerez le fichier <code>assets/stylesheets/common.css</code> en appelant l'url <code>http://localhost/</code> ou <code>http://localhost/stylesheets/common.css</code>.</p>
<h4>Source Map et Minification</h4><p>Par défaut, dans l'exemple ci-dessus un fichier <code>common.css.map</code> sera généré. Celui-ci permet à votre navigateur de vous indiqué qu'elle ligne du fichier <code>.less</code> a généré la propriété CSS de l'élément que vous avez sélectionné dans votre débuggeur.</p>
<p>Cela se désactive avec <code>enableLess.sourceMap</code> à <code>false</code> :</p>
<pre class="prettyprint source"><code>    &quot;enableLess&quot;: {
        &quot;sourceMap&quot;: false
    },
    &quot;routes&quot;: {
        &quot;/&quot;: &quot;index.htm&quot;
    }</code></pre><p>Vous pouvez également générer des fichiers CSS déjà minifiés avec :</p>
<pre class="prettyprint source"><code>    &quot;enableLess&quot;: {
        &quot;compress&quot;: true
    },
    &quot;routes&quot;: {
        &quot;/&quot;: &quot;index.htm&quot;
    }</code></pre><h3>Optimiser les Images</h3><p>Vous pouvez automatiquement optimiser les images que vous aller utiliser dans votre site pour en limiter le poids de chargement en créant des Optimizations en référençant les fichiers d'entrés par leur chemin d'accès et le chemin du fichier de sortie. Vous pouvez bien entendu en faire autant que vous le souhaitez. L'optimisation des images se fait à chaque démarrage de NodeAtlas que ce soit en tant que serveur ou via la commande <code>--generate</code> pour peut que des Optimizations existe dans le Webconfig.</p>
<h4>Créer des Optimizations</h4><p>Avec la configuration suivante :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;optimizations&quot;: {
        &quot;images&quot;: {
            &quot;media/images/example.min.png&quot;: &quot;media/images/example.png&quot;,
            &quot;media/images/example.min.jpg&quot;: &quot;media/images/example.jpg&quot;,
            &quot;media/images/example.min.gif&quot;: &quot;media/images/example.gif&quot;
        }
    },
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>et l'ensemble de fichier suivant :</p>
<pre class="prettyprint source"><code>assets/
— media/
—— images/
——— example.png
——— example.jpg
——— example.gif
templates/
— index.htm
webconfig.json</code></pre><p>vous obtiendrez les nouveaux fichiers suivant :</p>
<pre class="prettyprint source"><code>assets/
— media/
—— images/
——— example.png
——— example.jpg
——— example.gif
——— example.min.png    &lt;= nouveau fichier
——— example.min.jpg    &lt;= nouveau fichier
——— example.min.gif    &lt;= nouveau fichier
templates/
— index.htm
webconfig.json</code></pre><h4>Optimizations dans un fichier partagé</h4><p>Afin de ne pas ré-écrire une longue liste de configuration d'Optimizations dans un fichier <code>webconfig.json</code> à destination de votre environnement de développement et <code>webconfig.prod.json</code> à destination de votre environnement de production, vous pouvez mutaliser la déclaration des fichiers dans un fichier de votre choix. Par convention, c'est le fichier <code>optimizations.json</code>. </p>
<p>Par exemple :</p>
<p>L'ensemble de fichier suivant</p>
<pre class="prettyprint source"><code>assets/
— media/
—— images/
——— example.png
——— example.jpg
——— example.gif
templates/
— index.htm
webconfig.json
webconfig.prod.json</code></pre><p>avec <code>webconfig.json</code></p>
<pre class="prettyprint source lang-json"><code>{
    &quot;httpPort&quot;: 7777,
    &quot;optimizations&quot;: {
        &quot;images&quot;: {
            &quot;media/images/example.min.png&quot;: &quot;media/images/example.png&quot;,
            &quot;media/images/example.min.jpg&quot;: &quot;media/images/example.jpg&quot;,
            &quot;media/images/example.min.gif&quot;: &quot;media/images/example.gif&quot;
        }
    },
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>et avec <code>webconfig.prod.json</code></p>
<pre class="prettyprint source lang-json"><code>{
    &quot;httpPort&quot;: 7776,
    &quot;httpHostname&quot;: &quot;blog.lesieur.name&quot;,
    &quot;urlPort&quot;: 80,
    &quot;optimizations&quot;: {
        &quot;images&quot;: {
            &quot;media/images/example.min.png&quot;: &quot;media/images/example.png&quot;,
            &quot;media/images/example.min.jpg&quot;: &quot;media/images/example.jpg&quot;,
            &quot;media/images/example.min.gif&quot;: &quot;media/images/example.gif&quot;
        }
    },
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>pourrait devenir l'ensemble de fichier suivant</p>
<pre class="prettyprint source"><code>assets/
— media/
—— images/
——— example.png
——— example.jpg
——— example.gif
templates/
— index.htm
optimizations.json
webconfig.json
webconfig.prod.json</code></pre><p>avec <code>webconfig.json</code></p>
<pre class="prettyprint source lang-json"><code>{
    &quot;httpPort&quot;: 7777,
    &quot;optimizations&quot;: &quot;optimizations.json&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>avec <code>webconfig.prod.json</code></p>
<pre class="prettyprint source lang-json"><code>{
    &quot;httpPort&quot;: 7776,
    &quot;httpHostname&quot;: &quot;blog.lesieur.name&quot;,
    &quot;urlPort&quot;: 80,
    &quot;optimizations&quot;: &quot;optimizations.json&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>et <code>optimizations.json</code></p>
<pre class="prettyprint source lang-json"><code>{
    &quot;images&quot;: {
        &quot;media/images/example.min.png&quot;: &quot;media/images/example.png&quot;,
        &quot;media/images/example.min.jpg&quot;: &quot;media/images/example.jpg&quot;,
        &quot;media/images/example.min.gif&quot;: &quot;media/images/example.gif&quot;
    }
}</code></pre><p><em>Note : il est possible de désactiver les Optimizations en ne les incluant pas dans le <code>webconfig</code> en question.</em></p>
<h4>Désactiver des Optimizations</h4><p>Il est également possible de ne pas executer l'optimisation au démarage d'un site web avec NodeAtlas avec les propriétés <code>&quot;imagesOptimizationsEnable&quot;: false</code>.</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;imagesOptimizationsEnable&quot;: false,
    &quot;images&quot;: {
        &quot;media/images/example.min.png&quot;: &quot;media/images/example.png&quot;,
        &quot;media/images/example.min.jpg&quot;: &quot;media/images/example.jpg&quot;,
        &quot;media/images/example.min.gif&quot;: &quot;media/images/example.gif&quot;
    },
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p><em>Note : si vos optimizations sont dans un fichier partagé, vous pouvez également les désactiver simplement en retirand la ligne <code>&quot;optimizations&quot;: &quot;optimizations.json&quot;</code>.</em></p>
<h4>Ré-générer les Optimizations avant chaque rendu de page</h4><p>Vous pouvez demander à ce que les fichiers soient régénérés avant chaque affichage de page avec les propriétés <code>&quot;imagesOptimizationsBeforeResponse&quot;: true</code>.</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;imagesOptimizationsBeforeResponse&quot;: false,
    &quot;images&quot;: {
        &quot;media/images/example.min.png&quot;: &quot;media/images/example.png&quot;,
        &quot;media/images/example.min.jpg&quot;: &quot;media/images/example.jpg&quot;,
        &quot;media/images/example.min.gif&quot;: &quot;media/images/example.gif&quot;
    },
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p><em>Note : ceci n'est pas conseillé en production car cela ralenti les réponses des pages.</em></p>
<h3>Injecter du CSS inline pour maintenir des assets Email</h3><p>Quand on créer des templates pour envoyer des Newsletters par email, ou même de simple message, on ne peut pas attacher de feuille de style. Le seul moyen à notre disposition est d'écrire les instructions CSS dans le template à l'intérieur de l'attribut <code>style</code> brisant ainsi la séparation du font et de la forme.</p>
<h4>Injection spécifique</h4><p>Avec <code>injectCss</code>, il vous suffit d'habiller votre template comme à votre habitude via une feuille de style et NodeAtlas injectera à chaque rendu les styles dans l'attribut <code>style</code>. Il ne vous restera plus qu'à générer vos templates.</p>
<p>Avec par exemple la configuration suivante :</p>
<pre class="prettyprint source lang-json"><code>{
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;email.htm&quot;,
            &quot;generate&quot;: &quot;bienvenue.html&quot;,
            &quot;injectCss&quot;: &quot;stylesheets/email.css&quot;
        }
    }
}</code></pre><p>et l'ensemble de fichiers suivant :</p>
<pre class="prettyprint source"><code>generates/
assets/
— stylesheets/
—— email.css
templates/
— email.htm</code></pre><p>dont les contenus sont :</p>
<p><strong>stylesheets/common.css</strong></p>
<pre class="prettyprint source lang-css"><code>body {
    color: #f00;
}</code></pre><p><strong>templates/email.htm*</strong></p>
<pre class="prettyprint source lang-html"><code>&lt;!DOCTYPE html>
&lt;html lang=&quot;en&quot;>
    &lt;head>
        &lt;meta charset=&quot;UTF-8&quot;>
        &lt;title>Email&lt;/title>
    &lt;/head>
    &lt;body>
        &lt;p>This is a template email.&lt;/p>        
    &lt;/body>
&lt;/html></code></pre><p>vous obtiendrez en sortie avec la commande <code>node &lt;/path/to/&gt;node-atlas/node-atlas.js --generate</code> l'ensemble de fichier suivant :</p>
<pre class="prettyprint source"><code>generates/
— bienvenue.html    &lt;= template email prêt à l'envoi !
assets/
— stylesheets/
—— email.css
templates/
— email.htm</code></pre><p>avec comme contenu pour <code>generates/bienvenue.html</code></p>
<pre class="prettyprint source lang-html"><code>&lt;!DOCTYPE html>
&lt;html lang=&quot;en&quot;>
    &lt;head>
        &lt;meta charset=&quot;UTF-8&quot;>
        &lt;title>Email&lt;/title>
    &lt;/head>
    &lt;body style=&quot;color: #f00;&quot;>
        &lt;p>This is a template email.&lt;/p>        
    &lt;/body>
&lt;/html></code></pre><p>Ce mécanisme marche également si vous n'avez pas l'intention de générer quoi que ce soit mais sur un site qui tourne. Pratique pour modifier vos maquettes en live avant de les générer.</p>
<h4>Injection globale</h4><p>Il existe également la même propriété globale inpactant toutes les pages.</p>
<pre class="prettyprint source lang-json"><code>    &quot;injectCss&quot;: &quot;stylesheets/email.css&quot;
    &quot;routes&quot;: {
        &quot;/bienvenue/&quot;: {
            &quot;template&quot;: &quot;email-a.htm&quot;,
            &quot;generate&quot;: &quot;bienvenue.html&quot;
        },
        &quot;/au-revoir/&quot;: {
            &quot;template&quot;: &quot;email-b.htm&quot;,
            &quot;generate&quot;: &quot;au-revoir.html&quot;
        }
    }</code></pre><p>ainsi les deux pages <code>bienvenue</code> et <code>au-revoir</code> contiendront chacune <code>&lt;body style=&quot;color: #f00;&quot;&gt;</code>.</p>
<h4>Injection multiple</h4><p>Il est possible :</p>
<ul>
<li>De préciser des feuilles spécifique et commune en même temps.</li>
<li>De préciser plus d'une feuille à la fois.</li>
</ul>
<pre class="prettyprint source lang-json"><code>    &quot;injectCss&quot;: [&quot;stylesheets/reset.css&quot;, &quot;stylesheets/email.css&quot;]
    &quot;routes&quot;: {
        &quot;/bienvenue/&quot;: {
            &quot;template&quot;: &quot;email-a.htm&quot;,
            &quot;generate&quot;: &quot;bienvenue.html&quot;,
            &quot;injectCss&quot;: &quot;/stylesheets/welcome.css&quot;
        },
        &quot;/au-revoir/&quot;: {
            &quot;template&quot;: &quot;email-b.htm&quot;,
            &quot;generate&quot;: &quot;au-revoir.html&quot;,
            &quot;injectCss&quot;: [&quot;stylesheets/good-bye.css&quot;, &quot;/stylesheets/others.css&quot;]
        }
    }</code></pre><h3>Autoriser/Interdire les demandes GET/POST</h3><p>Vous pouvez également manager la manière dont le serveur va répondre aux demandes GET/POST pour une page donnée. Par exemple, nous allons autoriser l'accès aux pages uniquement en GET pour tout le site et autoriser un POST pour une page seulement (et même lui interdire le GET).</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;getSupport&quot;: true,
    &quot;postSupport&quot;: false,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        },
        &quot;/liste-des-membres/&quot;: {
            &quot;template&quot;: &quot;members.htm&quot;
        },
        &quot;/rediger-commentaire/&quot;: {
            &quot;template&quot;: &quot;write-com.htm&quot;
        },
        &quot;/commentaire-sauvegarde/&quot;: {
            &quot;template&quot;: &quot;save-com.htm&quot;,
            &quot;getSupport&quot;: false,
            &quot;postSupport&quot;: true
        }
    }
}</code></pre><p><em>Note : Si rien n'est précisé,</em> <strong><em>getSupport</em></strong> <em>et</em> <strong><em>postSupport</em></strong> <em>sont à</em> <strong><em>true</em></strong> <em>au niveau global et par page.</em></p>
<h3>Changer les paramètres des Sessions</h3><h4>Clé et Secret</h4><p>NodeAtlas gère lui-même les sessions stockées sur le serveur avec comme paramètres initiaux :</p>
<ul>
<li>Key : <code>nodeatlas.sid</code></li>
<li>Secret : <code>1234567890bépo</code></li>
</ul>
<p>qui permettent à un client de rester connecté à travers les pages à un même ensemble de variable personnelles côtés serveur.</p>
<p>Il est possible de modifier ses paramètres par défaut (et même obligatoire pour des sites en productions) avec les paramètres de <code>webconfig.json</code> suivant :</p>
<pre class="prettyprint source lang-js"><code>{
    sessionKey: &quot;clé personnelle&quot;,
    sessionSecret: &quot;secret personnel&quot;
}</code></pre><p>NodeAtlas utilise également un objet de stockage mémoire (MemoryStore) qui stoques les informations dans la RAM du serveur.</p>
<h4>Autres paramètres</h4><p>Il est possible de changer l'intégralité des paramètres des sessions (sauf le MemoryStore) en utilisant la configuration de <code>webconfig.json</code> suivante :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;session&quot;: {
        &quot;key&quot;: &quot;clé personnelle&quot;,
        &quot;secret&quot;: &quot;secret personnel&quot;,
        &quot;cookie&quot;: { 
            &quot;path&quot;: '/', 
            &quot;httpOnly&quot;: true, 
            &quot;secure&quot;: false, 
            &quot;maxAge&quot;: null
        },
        ...,
        ...,
        ...
    }
}</code></pre><p>L'intégralité de la configuration possible se trouve sur la documentation du module <a href="https://github.com/expressjs/session">express-session</a>.</p>
<h3>Stockage externe des Sessions</h3><p>Par défaut, c'est NodeAtlas qui stocke les sessions serveurs dans la RAM du serveur par application. Cela ne permet pas de partager des sessions utilisateurs à travers plusieurs applications NodeAtlas (ou autre) et efface toutes les sessions en cours pour une application en cas de redémarrage de celle-ci.</p>
<p>Pour résoudre ce soucis, il convient de prendre en charge l'enregistrement des sessions via une base No SQL tel que <code>Redis</code> ou <code>MongoBD</code>.</p>
<p>Pour cela il suffit d'utiliser la fonction <code>setSessions</code> dans le fichier <code>controllers/common.js</code> de la <a href="#utiliser-nodeatlas-pour-faire-tourner-un-site-partie-back-end">partie Back-end</a>.</p>
<h4>Session gérées avec Redis</h4><p>Implémenter le code suivant dans <code>controllers/common.js</code> pour stocker vos sessions dans Redis en local.</p>
<pre class="prettyprint source"><code>var website = {};

(function (publics) {
    &quot;use strict&quot;;

    publics.loadModules = function (NA) {
        NA.modules.RedisStore = require('connect-redis');

        return NA;
    };

    publics.setSessions = function (NA, callback) {
        var session = NA.modules.session,
            RedisStore = NA.modules.RedisStore(session);

        NA.sessionStore = new RedisStore();

        callback(NA);
    };  

}(website));

exports.loadModules = website.loadModules;
exports.setSessions = website.setSessions;</code></pre><p>Plus d'informations sur <a href="https://www.npmjs.org/package/connect-redis">connect-redis</a>.</p>
<h4>Session gérées avec MongoDB</h4><p>Implémenter le code suivant dans <code>controllers/common.js</code> pour stocker vos sessions dans la database <code>sessions</code> d'une MongoDB locale.</p>
<pre class="prettyprint source"><code>var website = {};

(function (publics) {
    &quot;use strict&quot;;

    publics.loadModules = function (NA) {
        NA.modules.MongoStore = require('connect-mongo');

        return NA;
    };

    publics.setSessions = function (NA, callback) {
        var session = NA.modules.session,
            MongoStore = NA.modules.MongoStore(session);

        NA.sessionStore = new MongoStore({
            db: 'sessions'
        });

        callback(NA);
    };  

}(website));

exports.loadModules = website.loadModules;
exports.setSessions = website.setSessions;</code></pre><p>Plus d'informations sur <a href="https://www.npmjs.org/package/connect-mongo">connect-redis</a>.</p>
<h3>Changer les chevrons &lt;% %&gt; du moteur de template</h3><p>Par exemple, pour inclure une partie de fichier on utilise l'instruction <strong><em>&lt;%- include('head.htm') %&gt;</em></strong>. Il serait possible de le faire avec <strong><em>&lt;?- include('head.htm') ?&gt;</em></strong> avec la configuration ci-dessous :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;templateEngineDelimiter&quot;: &quot;?&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>Voyez l'exemple dans les fichiers ci-dessous :</p>
<p><em>components/head.htm</em></p>
<pre class="prettyprint source lang-html"><code>&lt;!DOCTYPE html>
&lt;html lang=&quot;fr-fr&quot;>
    &lt;head>
        &lt;meta charset=&quot;utf-8&quot; />
        &lt;title>&lt;?= specific.titlePage ?>&lt;/title>

        &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;stylesheets/&lt;?= common.classCssCommon ?>.css&quot; media=&quot;all&quot; />
        &lt;link type=&quot;text/css&quot; rel=&quot;stylesheet&quot; href=&quot;stylesheets/&lt;?= specific.classPage ?>.css&quot; media=&quot;all&quot; />
    &lt;/head>
    &lt;body class=&quot;&lt;?= specific.classPage ?>&quot;></code></pre><p><em>components/foot.htm</em></p>
<pre class="prettyprint source lang-html"><code>        &lt;script async type=&quot;text/javascript&quot; src=&quot;javascript/&lt;?= common.classJsCommon ?>.js&quot;>&lt;/script>
    &lt;/body>
&lt;/html></code></pre><p><em>templates/template.htm</em></p>
<pre class="prettyprint source lang-html"><code>    &lt;? include('head.htm') ?>

    &lt;div class=&quot;title&quot;>&lt;?= common.titleWebsite ?>&lt;/div>

    &lt;div>
        &lt;h1>&lt;?= specific.titlePage ?>&lt;/h1>
        &lt;?- specific.content ?>
    &lt;/div>

    &lt;? include('foot.htm') ?></code></pre><p>Pour tout savoir sur les possibilités du moteur de template consulter la documentation <a href="https://github.com/mde/ejs">ejs</a></p>
<p><em>Note : Si rien n'est précisé,</em> <strong><em>templateEngineDelimiter</em></strong> <em>vaut</em> <strong><em>%</em></strong>.</p>
<h3>Changer l'url final des hostname et port d'écoute</h3><p>Il est possible de générer une url de visite différente des paramètres d'écoutes demandés avec <strong><em>urlHostname</em></strong> et <strong><em>urlPort</em></strong>. Par exemple on écoute la boucle local sur le port 80 car un script fait du Reverse Proxy depuis le port 7777 sur le 80 avec le module « http-proxy » comme ci-dessous :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;httpPort&quot;: 7777,
    &quot;httpHostname&quot;: &quot;127.0.0.1&quot;,
    &quot;urlPort&quot;: 80,
    &quot;urlHostname&quot;: &quot;localhost&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p>Il est également possible de faire en sorte qu'aucune autre url ne puisse être tapé. Ainsi si on réclame <code>www.localhost</code> ou <code>localhost:7777</code> c'est bien sur <code>localhost</code> que sera le visiteur :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;enableForceDomain&quot;: true,
    &quot;httpPort&quot;: 7777,
    &quot;httpHostname&quot;: &quot;127.0.0.1&quot;,
    &quot;urlPort&quot;: 80,
    &quot;urlHostname&quot;: &quot;localhost&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><h3>Générer les urls dynamiquement</h3><h4>Les chemins relatifs en absolue</h4><p>Il est possible que les chemins créés à partir de votre url soient interprétés comme des sous-dossiers qui n'ont en réalité aucune existance réelle. Cela a pour conséquence de rendre l'adresse <code>media/images/example.jpg</code> initialement accessible depuis un template affiché à <strong>http://localhost</strong><code>impossible à récupérer quand le template est affiché à **http://localhost/sub-directory/** (puisqu'il faudrait alors que notre chemin soit plutôt</code>../media/images/example.jpg`).</p>
<p>Pour ne plus avoir à se soucier de l'accès aux ressources peu importe l'url qui est demandée, il suffit de transformer toutes les urls relatives telles que :</p>
<pre class="prettyprint source"><code>&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;stylesheets/common.css&quot; />
&lt;!-- ... -->
&lt;img src=&quot;media/images/example.jpg&quot; />
&lt;!-- ... -->
&lt;script type=&quot;text/javascript&quot; src=&quot;javascript/common.js&quot;>&lt;/script></code></pre><p>en urls absolues avec la variable <code>urlBasePath</code> comme ci-dessous :</p>
<pre class="prettyprint source"><code>&lt;link rel=&quot;stylesheet&quot; type=&quot;text/css&quot; href=&quot;&lt;%= urlBasePath %>stylesheets/common.css&quot; />
&lt;!-- ... -->
&lt;img src=&quot;&lt;%= urlBasePath %>media/images/example.jpg&quot; />
&lt;!-- ... -->
&lt;script type=&quot;text/javascript&quot; src=&quot;&lt;%= urlBasePath %>javascript/common.js&quot;>&lt;/script></code></pre><p>À noter que dans le cas de la configuration suivante :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p><code>urlBasePath</code> retourne <code>http://localhost/</code> alors que dans celle-ci :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;httpPort&quot;: 7777,
    &quot;urlRelativeSubPath&quot;: &quot;/sub/folder&quot;,
    &quot;routes&quot;: {
        &quot;/&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        }
    }
}</code></pre><p><code>urlBasePath</code> retourne <code>http://localhost:7777/sub/folder/</code>.</p>
<h4>Les chemins des templates</h4><p>En utilisant le webconfig suivant :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;routes&quot;: {
        &quot;/index.html&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        },
        &quot;/contact.html&quot;: {
            &quot;template&quot;: &quot;contact.htm&quot;
        }
    }
}</code></pre><p>ainsi que le template <code>index.htm</code> correspondant</p>
<pre class="prettyprint source lang-html"><code>&lt;!-- ... -->
&lt;a href=&quot;http://localhost/index.html&quot;>Lien vers l'accueil&lt;/a>
&lt;a href=&quot;http://localhost/contact.html&quot;>Lien pour nous contacter&lt;/a>
&lt;!-- ... --></code></pre><p>je serais obligé de changer mon lien dans le template si je change le port d'écoute ou si je change le chemin de l'url. Le changement de configuration suivant :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;httpPort&quot;: 7777,
    &quot;routes&quot;: {
        &quot;/home.html&quot;: {
            &quot;template&quot;: &quot;index.htm&quot;
        },
        &quot;/contact-us.html&quot;: {
            &quot;template&quot;: &quot;contact.htm&quot;
        }
    }
}</code></pre><p>me contraindrait à modifier le template précédent comme suit :</p>
<pre class="prettyprint source lang-html"><code>&lt;!-- ... -->
&lt;a href=&quot;http://localhost:7777/home.html&quot;>Lien vers l'accueil&lt;/a>
&lt;a href=&quot;http://localhost:7777/contact-us.html&quot;>Lien pour nous contacter&lt;/a>
&lt;!-- ... --></code></pre><p>Il est possible de solutionner ce problème en donnant une clé à un chemin précis et en déportant sont chemin dans la propriété <code>url</code>.</p>
<p>Avec le webconfig suivant :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;routes&quot;: {
        &quot;index&quot;: {
            &quot;url&quot;: &quot;/index.html&quot;,
            &quot;template&quot;: &quot;index.htm&quot;
        },
        &quot;contact&quot;: {
            &quot;url&quot;: &quot;/contact.html&quot;,
            &quot;template&quot;: &quot;contact.htm&quot;
        }
    }
}</code></pre><p>je peux à présent écrire le lien dans le template de manière dynamique :</p>
<ol>
<li><p>comme suit</p>
<pre class="prettyprint source lang-html"><code>&lt;!-- ... -->
&lt;a href=&quot;&lt;%= urlBasePath %>&lt;%= webconfig.routes.home.url.slice(1) %>&quot;>Lien vers l'accueil&lt;/a>
&lt;a href=&quot;&lt;%= urlBasePath %>&lt;%= webconfig.routes.contact.url.slice(1) %>&quot;>Lien pour nous contacter&lt;/a>
&lt;!-- ... --></code></pre><p><em>Note : <code>.slice(1)</code> permet de supprimer facilement le double <code>/</code> pour une url fonctionnelle.</em></p>
</li>
<li><p>ou comme suit</p>
<pre class="prettyprint source lang-html"><code>&lt;!-- ... -->
&lt;a href=&quot;&lt;%= urlBasePath %>.&lt;%= webconfig.routes.home.url %>&quot;>Lien vers l'accueil&lt;/a>
&lt;a href=&quot;&lt;%= urlBasePath %>.&lt;%= webconfig.routes.contact.url %>&quot;>Lien pour nous contacter&lt;/a>
&lt;!-- ... --></code></pre><p><em>Note : Cela donnerait par exemple <code>http://localhost/./home.html</code>, ce qui est une url fonctionnelle.</em></p>
</li>
<li><p>ou comme suit</p>
<pre class="prettyprint source lang-html"><code>&lt;!-- ... -->
&lt;a href=&quot;&lt;%= urlBasePathSlice %>&lt;%= webconfig.routes.home.url %>&quot;>Lien vers l'accueil&lt;/a>
&lt;a href=&quot;&lt;%= urlBasePathSlice %>&lt;%= webconfig.routes.contact.url %>&quot;>Lien pour nous contacter&lt;/a>
&lt;!-- ... --></code></pre><p><em>Note : <code>urlBasePathSlice</code> renvoyant <code>http://localhost</code> au lieu de <code>http://localhost/</code> ou encore <code>http://localhost:7777/sub/folder</code> au lieu de <code>http://localhost:7777/sub/folder/</code>.</em></p>
</li>
</ol>
<h2>Commandes de lancement</h2><p>La façon la plus simple de lancer NodeAtlas est de se positionner dans le répertoire hébergeant votre site et de lancer la commande <code>\&gt; node &lt;/path/to/&gt;node-atlas/node-atlas.js</code>. Cependant il existe des options de lancement pour faire bien plus que lancer le site.</p>
<p>Chacune des commandes qui vont suivre peut être couplée avec les autres de cette manière :</p>
<pre class="prettyprint source"><code>\> node &lt;/path/to/>node-atlas/node-atlas.js --directory /hello-world/ --webconfig config.fr-fr.js --httpPort 80 --browse</code></pre><h3>--directory <path></h3><p>Il est possible de lancer NodeAtlas depuis un autre endroit que le dossier où est hébergé le site que vous souhaitez faire tourner. La commande <code>--directory</code> vous sera alors très utile.</p>
<pre class="prettyprint source"><code>\> node &lt;/path/to/>node-atlas/node-atlas.js --directory &lt;/path/to/your/website/directory/></code></pre><h3>--webconfig <webconfigName></h3><p>Par défaut, NodeAtlas va lire votre fichier <code>webconfig.json</code>. Il est possible qu'en plus de ce fichier vous ayez créé un autre fichier <code>webconfig.prod.json</code> dont le nom de domaine est différent. Ou encore un <code>webconfig.fr-fr.json</code> avec des urls et des variations dans une autre langue. Plutôt que de renommer vos fichiers en <code>webconfig.json</code> avant de lancer le site, précisez simplement votre autre nom de configuration. Dans l'exemple suivant, notre fichier sera <code>webconfig.alternatif.json</code>.</p>
<pre class="prettyprint source"><code>\> node &lt;/path/to/>node-atlas/node-atlas.js --webconfig webconfig.alternatif.json</code></pre><h3>--browse [subpath]</h3><p>Cette commande permet d'ouvrir votre navigateur à l'adresse sur laquelle le site va tourner. Très pratique quand vous ne vous souvenez plus du port pour votre version de développement. Cette commande ne sert à rien si elle est couplé avec <code>--generate</code> (voir plus loin).</p>
<pre class="prettyprint source"><code>\> node &lt;/path/to/>node-atlas/node-atlas.js --browse</code></pre><p>Vous pouvez également cibler une page précise en ajoutant la fin de l'url.</p>
<pre class="prettyprint source"><code>\> node &lt;/path/to/>node-atlas/node-atlas.js --browse index.html</code></pre><h3>--httpPort <httpPort></h3><p>Vous n'allez peut être pas vous ennuyer à changer votre port d'écoute sur tous vos projets et parfois vous allez devoir travailler sur deux sites différents en même temps. Avec cette commande vous n'aurez pas besoin de couper vos sites alternativement pour libérer le port d'écoute, il suffira d'en choisir un au lancement.</p>
<pre class="prettyprint source"><code>\> node &lt;/path/to/>node-atlas/node-atlas.js --httpPort 7778</code></pre><h3>--generate</h3><p>Si vous modifiez un élément dans votre fichier de variation commun ou même dans un de vos composants de template appelé sur plusieurs pages, vous n'allez pas recharger chaque page pour mettre à jour vos fichiers de sortie. Il suffira alors d'utiliser <code>--generate</code>. Cette commande copiera l'intégralité du contenu du dossier <code>assetsRelativePath</code> dans <code>generatesRelativePath</code> si leur chemin est différent.</p>
<pre class="prettyprint source"><code>\> node &lt;/path/to/>node-atlas/node-atlas.js --generate</code></pre><h2>NodeAtlas comme module npm</h2><p>Si vous lancez NodeAtlas via du code JavaScript, vous pouvez également configurer le lancement :</p>
<p><em>server.js</em></p>
<pre class="prettyprint source lang-javascript"><code>require(&quot;node-atlas&quot;).run({
    directory: &quot;&lt;/path/to/your/website/directory/>&quot;,
    webconfig: &quot;webconfig.alternatif.json&quot;,
    browse: true,
    httpPort: 7778,
    generate: true
});</code></pre><pre class="prettyprint source"><code>\> node server.js</code></pre><h2>NodeAtlas comme simple serveur web</h2><p>Si NodeAtlas ne trouve pas le « webconfig.json » ou le <code>--webconfig</code> que vous lui aurez indiqué, il se lancera en mode « Simple Serveur Web » ou « Public ».</p>
<p><strong>Ce mode est pratique pour tester très rapidement que NodeAtlas est correctement installé ou pour créer des petits exemples HTML qui ont besoin d'un serveur web pour fonctionner (retours AJAX, iframe embarquée, etc.).</strong></p>
<p>Pour bien comprendre ce que cela signifie : s'il existe un quelconque fichier dans le répertoire d'où NodeAtlas a été lancé, il sera renvoyé par requête HTTP si ont le réclame via son chemin d'accès.</p>
<p>Par exemple, en lançant NodeAtlas dans le répertoire <code>site-hello-world</code></p>
<pre class="prettyprint source"><code>site-hello-world/
— templates/
—— index.htm
— webconfig.json</code></pre><p>en exécutant la commande </p>
<pre class="prettyprint source"><code>\> node &lt;/path/to/>node-atlas/node-atlas.js</code></pre><p>ou même la commande</p>
<pre class="prettyprint source"><code>\> node &lt;/path/to/>node-atlas/node-atlas.js --webconfig webconfig.not-exist.json</code></pre><p>le serveur se lancera en mode « Simple Serveur Web » et les fichiers « http://localhost/webconfig.json » ou « http://localhost/templates/webconfig.htm » seront accessible tel que le navigateur pourrait les renvoyer en tant que simple serveur web.</p>
<p><em>Note : seul les commandes <code>--webconfig</code>, <code>--browse</code>, <code>--directory</code> et <code>--httpPort</code> fonctionnent dans ce mode.</em></p>
<h2>Faire tourner NodeAtlas sur serveur</h2><h3>Dans un environnement Windows Server avec iisnode</h3><p>Dans un environnement Windows Server 2013 avec IIS8 il faut :</p>
<ol>
<li>Installer <a href="http://nodejs.org/download/">l’exécutable node.exe</a> capable d’exécuter du code JavaScript.</li>
<li>Installer <a href="http://www.iis.net/downloads/microsoft/url-rewrite">le module IIS8 UrlRewrite</a> pour mapper les pages exécutées à une Url de sortie.</li>
<li>Installer <a href="https://github.com/tjanczuk/iisnode/downloads">le module IIS8 issnode</a> pour lire des web.config et manager des site via IIS (Management de pool d’application, démarrage/arrêt de site, etc...).</li>
</ol>
<h4>Créer une application</h4><p>Dans IIS8, créez un Website et créez une Application.</p>
<p>Le contenu de votre application sera celui du site mélangé à celui de NodeAtlas. Cela signifie donc que ceci :</p>
<pre class="prettyprint source"><code>node-atlas/
— node_modules/
— languages/
—— default.json
— node-atlas.js
site-hello-world/
— assets/
— templates/
—— index.htm
— webconfig.json</code></pre><p>devient ceci :</p>
<pre class="prettyprint source"><code>site-hello-world/
— node_modules/
— languages/
—— default.json
— assets/
— templates/
—— index.htm
— node-atlas.js
— webconfig.json</code></pre><p>Vous rajouterez à cet ensemble de fichiers, un fichier supplémentaire nommé <code>web.config</code> dont le contenu est le suivant :</p>
<pre class="prettyprint source lang-xml"><code>&lt;configuration>
    &lt;system.webServer>
        &lt;handlers>
            &lt;add name=&quot;iisnode&quot; path=&quot;node-atlas.js&quot; verb=&quot;*&quot; modules=&quot;iisnode&quot; />
        &lt;/handlers>
        &lt;rewrite>
            &lt;rules>
                &lt;rule name=&quot;LogFile&quot; patternSyntax=&quot;ECMAScript&quot; stopProcessing=&quot;true&quot;>
                     &lt;match url=&quot;^[a-zA-Z0-9_\-]+\.js\.logs\/\d+\.txt$&quot;/>
                &lt;/rule>
                &lt;rule name=&quot;NodeInspector&quot; patternSyntax=&quot;ECMAScript&quot; stopProcessing=&quot;true&quot;>                    
                    &lt;match url=&quot;^node-atlas.js\/debug[\/]?&quot; />
                &lt;/rule>
                &lt;rule name=&quot;StaticContent&quot;>
                     &lt;action type=&quot;Rewrite&quot; url=&quot;assets{REQUEST_URI}&quot;/>
                &lt;/rule>
                &lt;rule name=&quot;DynamicContent&quot;>
                     &lt;conditions>
                          &lt;add input=&quot;{REQUEST_FILENAME}&quot; matchType=&quot;IsFile&quot; negate=&quot;True&quot;/>
                     &lt;/conditions>
                     &lt;action type=&quot;Rewrite&quot; url=&quot;node-atlas.js&quot;/>
                &lt;/rule>
            &lt;/rules>
        &lt;/rewrite>

    &lt;/system.webServer>
&lt;/configuration></code></pre><p>pour au final obtenir :</p>
<pre class="prettyprint source"><code>site-hello-world/
— node_modules/
— languages/
—— default.json
— assets/
— templates/
—— index.htm
— node-atlas.js
— webconfig.json
— web.config</code></pre><p>Il ne vous restera plus qu'à cliquer sur « Browse <url-of-site> » dans votre panneau d'action IIS8. Vous pouvez dès lors manager votre site (Démarrage / Arrêt / Recyclage de Pool) comme pour n'importe quelle autre application IIS8.</p>
<h4>webconfig exemple</h4><p>Un webconfig exemple pour une production :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;urlPort&quot;: 80,
    &quot;httpPort&quot;: 7777,
    &quot;httpHostname&quot;: &quot;www.example.fr&quot;,
    &quot;routes&quot;: {
        ...
    }
}</code></pre><h3>Dans un environnement Unix avec forever</h3><p>Il faut pour cela :</p>
<ol>
<li>Installer <a href="http://nodejs.org/download/">l’exécutable node.exe</a> capable d’exécuter du code JavaScript.</li>
<li>Installer <a href="https://github.com/nodejitsu/forever">le CLI tool forever</a> pour manager vos sites en continue (démarrage, arrêt, redémarrage, etc.).</li>
<li>Faire tourner en plus de vos sites un reverse-proxy pour que toutes vos applications tournent sur le port 80.</li>
</ol>
<h4>Quelques commandes forever</h4><p>Pour manager un nouveau site en continue il faut utiliser la commande :</p>
<pre class="prettyprint source"><code>\> forever start &lt;/path/to/>node-atlas/node-atlas.js --directory &lt;/path/to/your/website/directory/></code></pre><p>Pour le stopper, il faut repérer son <strong>uid</strong> avec la commande <code>forever list</code></p>
<pre class="prettyprint source"><code>\> forever list</code></pre><p>puis utiliser la commande :</p>
<pre class="prettyprint source"><code>\> forever stop &lt;uid></code></pre><p>ou <code>&lt;uid&gt;</code> est l'<strong>uid</strong> du site qui tourne.</p>
<h4>webconfig exemple</h4><p>Un webconfig exemple pour une production :</p>
<pre class="prettyprint source lang-js"><code>{
    &quot;urlPort&quot;: 80,
    &quot;httpPort&quot;: 7777,
    &quot;httpHostname&quot;: &quot;www.example.fr&quot;,
    &quot;routes&quot;: {
        ...
    }
}</code></pre><p>Il vous faudra ensuite utiliser un reverse-proxy pour rendre votre site accessible sur le port 80.</p>
<h3>Proxy</h3><h4>Bouncy</h4><p>Bouncy est un exemple de reverse-proxy que vous pouvez utiliser pour faire tourner divers sites NodeAtlas (avec d'autres types de site) ensemble sur le même port (le 80).</p>
<p>Vous pouvez par exemple :</p>
<ul>
<li>lancer 3 applications Node.js sur les ports 7777, 7778 et 7779 avec forever,</li>
<li>et en plus lancer un server apache sur le port 81 </li>
</ul>
<p>et rendre tous vos sites accessibles derrière des noms de domaines sur le port 80 avec Bouncy par exemple.</p>
<p>Voici un exemple de configuration avec Bouncy :</p>
<p><strong>global-server.js</strong></p>
<pre class="prettyprint source lang-javascript"><code>var bouncy = require('bouncy');

var server = bouncy(function (request, response, bounce) {
    if (request.headers.host === 'beep.example.com') {
        bounce(7777);
    }
    else if (request.headers.host === 'blup.example.com') {
        bounce(7776);
    }
    else if (request.headers.host === 'boop.example.com') {
        bounce(81);
    }
    else {
        response.statusCode = 404;
        response.end('no such host');
    }
});

server.listen(80);</code></pre><p>que vous pouvez lancer avec :</p>
<pre class="prettyprint source"><code>\> forever start &lt;/path/to/>global-server.js</code></pre><p><a href="https://github.com/substack/bouncy">Plus d'informations sur Bouncy</a></p>
<h2>À propos de l'architecture de NodeAtlas</h2><p>NodeAtlas est fait de tel sorte que l'objet <code>NA</code> contienne l'intégralité des fonctions lui permettant de fonctionner. NodeAtlas délivre lui-même son objet dans les controllers via les méthodes utilisées en mode Back-end avec Node.js pour vous permettre de changer ponctuellement son comportement.</p>
<p>Tous les messages d'erreurs se trouvent dans <code>/languages/default.json</code>. Si vous souhaitez les modifier, il suffit de remplacer le contenu de <code>default.json</code> (actuellement identique à celui de <code>en-gb</code>) par celui de <code>fr-fr.json</code> ou tout autre fichier traduit par vos soins.</p>
<p>Pour finir <a href="http://blog.lesieur.name/structurer-le-javascript-de-son-site-avec-ou-sans-framework/">l'appoche publics/privates de l'architecture est expliqué dans cette article</a>.</p></article>
    </section>







				</div>

				<div class="clearfix"></div>
				<footer>
					
					This project is maintained by <a href="https://github.com/Haeresis">Haeresis</a>
					<br />
					
					
		<span class="copyright">
		<a href="https://www.npmjs.org/package/node-atlas">This project is a npm module</a>
		</span>
					<br />
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha11</a>
		on 2015-06-22T18:36:57+02:00 using the <a
			href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<div class="span3">
				<div id="toc"></div>
			</div>
			
			<br clear="both">
		</div>

	</div>
	<!--<script src="scripts/sunlight.js"></script>-->
	<script src="scripts/docstrap.lib.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>

	<script>
		$( function () {
			$( "[id*='$']" ).each( function () {
				var $this = $( this );

				$this.attr( "id", $this.attr( "id" ).replace( "$", "__" ) );
			} );

			$( "#toc" ).toc( {
				anchorName  : function ( i, heading, prefix ) {
					return $( heading ).attr( "id" ) || ( prefix + i );
				},
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : "100px"
			} );

			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );
			$( '.dropdown-toggle' ).dropdown();
//			$( ".tutorial-section pre, .readme-section pre" ).addClass( "sunlight-highlight-javascript" ).addClass( "linenums" );

			$( ".tutorial-section pre, .readme-section pre" ).each( function () {
				var $this = $( this );

				var example = $this.find( "code" );
				exampleText = example.html();
				var lang = /{@lang (.*?)}/.exec( exampleText );
				if ( lang && lang[1] ) {
					exampleText = exampleText.replace( lang[0], "" );
					example.html( exampleText );
					lang = lang[1];
				} else {
					lang = "javascript";
				}

				if ( lang ) {

					$this
						.addClass( "sunlight-highlight-" + lang )
						.addClass( "linenums" )
						.html( example.html() );

				}
			} );

			Sunlight.highlightAll( {
				lineNumbers : true,
				showMenu : true,
				enableDoclinks : true
			} );
		} );
	 </script>



	<!--Navigation and Symbol Display-->
	


	<!--Google Analytics-->
	

</body>
</html>